#
MODULE YOWFIELD_MOD

   USE PARKIND_WAVE, ONLY : JWRB, JWIM
   USE FIELD_MODULE, ONLY : FIELD_3D_WRAPPER, FIELD_3D, FIELD_INT2D, FIELD_INT2D_WRAPPER, FIELD_2D, FIELD_2D_WRAPPER, &
 &                          FIELD_INT3D, FIELD_INT3D_WRAPPER, FIELD_4D, FIELD_4D_WRAPPER, FIELD_INT4D, FIELD_INT4D_WRAPPER
   IMPLICIT NONE

   TYPE FREQUENCY_FIELD
#ifndef WAM_PHYS_GPU
          REAL(KIND=JWRB), DIMENSION(:,:), POINTER :: WAVNUM=>NULL()
          REAL(KIND=JWRB), DIMENSION(:,:), POINTER :: CINV=>NULL()
          REAL(KIND=JWRB), DIMENSION(:,:), POINTER :: CGROUP=>NULL()
          REAL(KIND=JWRB), DIMENSION(:,:), POINTER :: XK2CG=>NULL()
          REAL(KIND=JWRB), DIMENSION(:,:), POINTER :: OMOSNH2KD=>NULL()
          REAL(KIND=JWRB), DIMENSION(:,:), POINTER :: STOKFAC=>NULL()
          REAL(KIND=JWRB), DIMENSION(:,:), POINTER :: CIWA=>NULL()
#endif
          CLASS(FIELD_3D), POINTER :: F_WAVNUM=>NULL()
          CLASS(FIELD_3D), POINTER :: F_CINV=>NULL()
          CLASS(FIELD_3D), POINTER :: F_CGROUP=>NULL()
          CLASS(FIELD_3D), POINTER :: F_XK2CG=>NULL()
          CLASS(FIELD_3D), POINTER :: F_OMOSNH2KD=>NULL()
          CLASS(FIELD_3D), POINTER :: F_STOKFAC=>NULL()
          CLASS(FIELD_3D), POINTER :: F_CIWA=>NULL()
      CONTAINS
         PROCEDURE :: INIT => FREQUENCY_FIELD_INIT
#ifdef WAM_PHYS_GPU
         PROCEDURE :: UPDATE_DEVICE => FREQUENCY_UPDATE_DEVICE
         PROCEDURE :: ENSURE_HOST => FREQUENCY_ENSURE_HOST
         PROCEDURE :: DEVICE_POINTER=> FREQUENCY_DEVICE_POINTER
         PROCEDURE :: INIT_UPDATE=> FREQUENCY_FIELD_INIT_UPDATE
#else
         PROCEDURE :: UPDATE_VIEW => FREQUENCY_UPDATE_VIEW
#endif
   END TYPE FREQUENCY_FIELD

   TYPE ENVIRONMENT_FIELD
#ifndef WAM_PHYS_GPU
          INTEGER(KIND=JWIM), DIMENSION(:), POINTER :: INDEP=>NULL()
          INTEGER(KIND=JWIM), DIMENSION(:), POINTER :: IODP=>NULL()
          INTEGER(KIND=JWIM), DIMENSION(:), POINTER :: IOBND=>NULL()
          REAL(KIND=JWRB), DIMENSION(:), POINTER :: DELLAM1=>NULL()
          REAL(KIND=JWRB), DIMENSION(:), POINTER :: COSPHM1=>NULL()
          REAL(KIND=JWRB), DIMENSION(:), POINTER :: DEPTH=>NULL()
          REAL(KIND=JWRB), DIMENSION(:), POINTER :: EMAXDPT=>NULL()
          REAL(KIND=JWRB), DIMENSION(:), POINTER :: UCUR=>NULL()
          REAL(KIND=JWRB), DIMENSION(:), POINTER :: VCUR=>NULL()
#endif
          CLASS(FIELD_INT2D), POINTER :: F_INDEP=>NULL()
          CLASS(FIELD_INT2D), POINTER :: F_IODP=>NULL()
          CLASS(FIELD_INT2D), POINTER :: F_IOBND=>NULL()
          CLASS(FIELD_2D), POINTER :: F_DELLAM1=>NULL()
          CLASS(FIELD_2D), POINTER :: F_COSPHM1=>NULL()
          CLASS(FIELD_2D), POINTER :: F_DEPTH=>NULL()
          CLASS(FIELD_2D), POINTER :: F_EMAXDPT=>NULL()
          CLASS(FIELD_2D), POINTER :: F_UCUR=>NULL()
          CLASS(FIELD_2D), POINTER :: F_VCUR=>NULL()
      CONTAINS
         PROCEDURE :: INIT => ENVIRONMENT_FIELD_INIT
#ifdef WAM_PHYS_GPU
         PROCEDURE :: UPDATE_DEVICE => ENVIRONMENT_UPDATE_DEVICE
         PROCEDURE :: ENSURE_HOST => ENVIRONMENT_ENSURE_HOST
         PROCEDURE :: DEVICE_POINTER=> ENVIRONMENT_DEVICE_POINTER
         PROCEDURE :: INIT_UPDATE=> ENVIRONMENT_FIELD_INIT_UPDATE
#else
         PROCEDURE :: UPDATE_VIEW => ENVIRONMENT_UPDATE_VIEW
#endif
   END TYPE ENVIRONMENT_FIELD

   TYPE FORCING_FIELDS_FIELD
#ifndef WAM_PHYS_GPU
          REAL(KIND=JWRB), DIMENSION(:), POINTER :: UWND=>NULL()
          REAL(KIND=JWRB), DIMENSION(:), POINTER :: VWND=>NULL()
          REAL(KIND=JWRB), DIMENSION(:), POINTER :: AIRD=>NULL()
          REAL(KIND=JWRB), DIMENSION(:), POINTER :: WSTAR=>NULL()
          REAL(KIND=JWRB), DIMENSION(:), POINTER :: CICOVER=>NULL()
          REAL(KIND=JWRB), DIMENSION(:), POINTER :: CITHICK=>NULL()
          REAL(KIND=JWRB), DIMENSION(:), POINTER :: LKFR=>NULL()
          REAL(KIND=JWRB), DIMENSION(:), POINTER :: UCUR=>NULL()
          REAL(KIND=JWRB), DIMENSION(:), POINTER :: VCUR=>NULL()
          REAL(KIND=JWRB), DIMENSION(:), POINTER :: WSWAVE=>NULL()
          REAL(KIND=JWRB), DIMENSION(:), POINTER :: WDWAVE=>NULL()
          REAL(KIND=JWRB), DIMENSION(:), POINTER :: UFRIC=>NULL()
          REAL(KIND=JWRB), DIMENSION(:), POINTER :: TAUW=>NULL()
          REAL(KIND=JWRB), DIMENSION(:), POINTER :: TAUWDIR=>NULL()
          REAL(KIND=JWRB), DIMENSION(:), POINTER :: Z0M=>NULL()
          REAL(KIND=JWRB), DIMENSION(:), POINTER :: Z0B=>NULL()
          REAL(KIND=JWRB), DIMENSION(:), POINTER :: CHRNCK=>NULL()
          REAL(KIND=JWRB), DIMENSION(:), POINTER :: XLON=>NULL()
          REAL(KIND=JWRB), DIMENSION(:), POINTER :: YLAT=>NULL()
#endif
          CLASS(FIELD_2D), POINTER :: F_UWND=>NULL()
          CLASS(FIELD_2D), POINTER :: F_VWND=>NULL()
          CLASS(FIELD_2D), POINTER :: F_AIRD=>NULL()
          CLASS(FIELD_2D), POINTER :: F_WSTAR=>NULL()
          CLASS(FIELD_2D), POINTER :: F_CICOVER=>NULL()
          CLASS(FIELD_2D), POINTER :: F_CITHICK=>NULL()
          CLASS(FIELD_2D), POINTER :: F_LKFR=>NULL()
          CLASS(FIELD_2D), POINTER :: F_UCUR=>NULL()
          CLASS(FIELD_2D), POINTER :: F_VCUR=>NULL()
          CLASS(FIELD_2D), POINTER :: F_WSWAVE=>NULL()
          CLASS(FIELD_2D), POINTER :: F_WDWAVE=>NULL()
          CLASS(FIELD_2D), POINTER :: F_UFRIC=>NULL()
          CLASS(FIELD_2D), POINTER :: F_TAUW=>NULL()
          CLASS(FIELD_2D), POINTER :: F_TAUWDIR=>NULL()
          CLASS(FIELD_2D), POINTER :: F_Z0M=>NULL()
          CLASS(FIELD_2D), POINTER :: F_Z0B=>NULL()
          CLASS(FIELD_2D), POINTER :: F_CHRNCK=>NULL()
          CLASS(FIELD_2D), POINTER :: F_XLON=>NULL()
          CLASS(FIELD_2D), POINTER :: F_YLAT=>NULL()
      CONTAINS
         PROCEDURE :: INIT => FORCING_FIELDS_FIELD_INIT
#ifdef WAM_PHYS_GPU
         PROCEDURE :: UPDATE_DEVICE => FORCING_FIELDS_UPDATE_DEVICE
         PROCEDURE :: ENSURE_HOST => FORCING_FIELDS_ENSURE_HOST
         PROCEDURE :: DEVICE_POINTER=> FORCING_FIELDS_DEVICE_POINTER
         PROCEDURE :: INIT_UPDATE=> FORCING_FIELDS_FIELD_INIT_UPDATE
#else
         PROCEDURE :: UPDATE_VIEW => FORCING_FIELDS_UPDATE_VIEW
#endif
   END TYPE FORCING_FIELDS_FIELD

   TYPE WAVE2OCEAN_FIELD
#ifndef WAM_PHYS_GPU
          REAL(KIND=JWRB), DIMENSION(:), POINTER :: NSWH=>NULL()
          REAL(KIND=JWRB), DIMENSION(:), POINTER :: NMWP=>NULL()
          REAL(KIND=JWRB), DIMENSION(:), POINTER :: NPHIEPS=>NULL()
          REAL(KIND=JWRB), DIMENSION(:), POINTER :: NEMOPHIF=>NULL()
          REAL(KIND=JWRB), DIMENSION(:), POINTER :: NTAUOC=>NULL()
          REAL(KIND=JWRB), DIMENSION(:), POINTER :: NEMOTAUX=>NULL()
          REAL(KIND=JWRB), DIMENSION(:), POINTER :: NEMOTAUY=>NULL()
          REAL(KIND=JWRB), DIMENSION(:), POINTER :: NEMOUSTOKES=>NULL()
          REAL(KIND=JWRB), DIMENSION(:), POINTER :: NEMOVSTOKES=>NULL()
          REAL(KIND=JWRB), DIMENSION(:), POINTER :: NEMOSTRN=>NULL()
          REAL(KIND=JWRB), DIMENSION(:), POINTER :: NEMOWSWAVE=>NULL()
#endif
          CLASS(FIELD_2D), POINTER :: F_NSWH=>NULL()
          CLASS(FIELD_2D), POINTER :: F_NMWP=>NULL()
          CLASS(FIELD_2D), POINTER :: F_NPHIEPS=>NULL()
          CLASS(FIELD_2D), POINTER :: F_NEMOPHIF=>NULL()
          CLASS(FIELD_2D), POINTER :: F_NTAUOC=>NULL()
          CLASS(FIELD_2D), POINTER :: F_NEMOTAUX=>NULL()
          CLASS(FIELD_2D), POINTER :: F_NEMOTAUY=>NULL()
          CLASS(FIELD_2D), POINTER :: F_NEMOUSTOKES=>NULL()
          CLASS(FIELD_2D), POINTER :: F_NEMOVSTOKES=>NULL()
          CLASS(FIELD_2D), POINTER :: F_NEMOSTRN=>NULL()
          CLASS(FIELD_2D), POINTER :: F_NEMOWSWAVE=>NULL()
      CONTAINS
         PROCEDURE :: INIT => WAVE2OCEAN_FIELD_INIT
#ifdef WAM_PHYS_GPU
         PROCEDURE :: UPDATE_DEVICE => WAVE2OCEAN_UPDATE_DEVICE
         PROCEDURE :: ENSURE_HOST => WAVE2OCEAN_ENSURE_HOST
         PROCEDURE :: DEVICE_POINTER=> WAVE2OCEAN_DEVICE_POINTER
         PROCEDURE :: INIT_UPDATE=> WAVE2OCEAN_FIELD_INIT_UPDATE
#else
         PROCEDURE :: UPDATE_VIEW => WAVE2OCEAN_UPDATE_VIEW
#endif
   END TYPE WAVE2OCEAN_FIELD

   TYPE INTGT_PARAM_FIELDS_FIELD
#ifndef WAM_PHYS_GPU
          REAL(KIND=JWRB), DIMENSION(:), POINTER :: WSEMEAN=>NULL()
          REAL(KIND=JWRB), DIMENSION(:), POINTER :: WSFMEAN=>NULL()
          REAL(KIND=JWRB), DIMENSION(:), POINTER :: USTOKES=>NULL()
          REAL(KIND=JWRB), DIMENSION(:), POINTER :: VSTOKES=>NULL()
          REAL(KIND=JWRB), DIMENSION(:), POINTER :: PHIEPS=>NULL()
          REAL(KIND=JWRB), DIMENSION(:), POINTER :: PHIOCD=>NULL()
          REAL(KIND=JWRB), DIMENSION(:), POINTER :: PHIAW=>NULL()
          REAL(KIND=JWRB), DIMENSION(:), POINTER :: TAUOC=>NULL()
          REAL(KIND=JWRB), DIMENSION(:), POINTER :: TAUXD=>NULL()
          REAL(KIND=JWRB), DIMENSION(:), POINTER :: TAUYD=>NULL()
          REAL(KIND=JWRB), DIMENSION(:), POINTER :: TAUOCXD=>NULL()
          REAL(KIND=JWRB), DIMENSION(:), POINTER :: TAUOCYD=>NULL()
          REAL(KIND=JWRB), DIMENSION(:), POINTER :: STRNMS=>NULL()
          REAL(KIND=JWRB), DIMENSION(:), POINTER :: ALTWH=>NULL()
          REAL(KIND=JWRB), DIMENSION(:), POINTER :: CALTWH=>NULL()
          REAL(KIND=JWRB), DIMENSION(:), POINTER :: RALTCOR=>NULL()
#endif
          CLASS(FIELD_2D), POINTER :: F_WSEMEAN=>NULL()
          CLASS(FIELD_2D), POINTER :: F_WSFMEAN=>NULL()
          CLASS(FIELD_2D), POINTER :: F_USTOKES=>NULL()
          CLASS(FIELD_2D), POINTER :: F_VSTOKES=>NULL()
          CLASS(FIELD_2D), POINTER :: F_PHIEPS=>NULL()
          CLASS(FIELD_2D), POINTER :: F_PHIOCD=>NULL()
          CLASS(FIELD_2D), POINTER :: F_PHIAW=>NULL()
          CLASS(FIELD_2D), POINTER :: F_TAUOC=>NULL()
          CLASS(FIELD_2D), POINTER :: F_TAUXD=>NULL()
          CLASS(FIELD_2D), POINTER :: F_TAUYD=>NULL()
          CLASS(FIELD_2D), POINTER :: F_TAUOCXD=>NULL()
          CLASS(FIELD_2D), POINTER :: F_TAUOCYD=>NULL()
          CLASS(FIELD_2D), POINTER :: F_STRNMS=>NULL()
          CLASS(FIELD_2D), POINTER :: F_ALTWH=>NULL()
          CLASS(FIELD_2D), POINTER :: F_CALTWH=>NULL()
          CLASS(FIELD_2D), POINTER :: F_RALTCOR=>NULL()
      CONTAINS
         PROCEDURE :: INIT => INTGT_PARAM_FIELDS_FIELD_INIT
#ifdef WAM_PHYS_GPU
         PROCEDURE :: UPDATE_DEVICE => INTGT_PARAM_FIELDS_UPDATE_DEVICE
         PROCEDURE :: ENSURE_HOST => INTGT_PARAM_FIELDS_ENSURE_HOST
         PROCEDURE :: DEVICE_POINTER=> INTGT_PARAM_FIELDS_DEVICE_POINTER
         PROCEDURE :: INIT_UPDATE=> INTGT_PARAM_FIELDS_FIELD_INIT_UPDATE
#else
         PROCEDURE :: UPDATE_VIEW => INTGT_PARAM_FIELDS_UPDATE_VIEW
#endif
   END TYPE INTGT_PARAM_FIELDS_FIELD

   TYPE SOURCE_CONTRIBS_FIELD
#ifndef WAM_PHYS_GPU
          REAL(KIND=JWRB), DIMENSION(:,:,:), POINTER :: FL1=>NULL()
          REAL(KIND=JWRB), DIMENSION(:,:,:), POINTER :: XLLWS=>NULL()
          INTEGER(KIND=JWIM), DIMENSION(:), POINTER :: MIJ=>NULL()
#endif
          CLASS(FIELD_4D), POINTER :: F_FL1=>NULL()
          CLASS(FIELD_4D), POINTER :: F_XLLWS=>NULL()
          CLASS(FIELD_INT2D), POINTER :: F_MIJ=>NULL()
      CONTAINS
         PROCEDURE :: INIT => SOURCE_CONTRIBS_FIELD_INIT
#ifdef WAM_PHYS_GPU
         PROCEDURE :: UPDATE_DEVICE => SOURCE_CONTRIBS_UPDATE_DEVICE
         PROCEDURE :: ENSURE_HOST => SOURCE_CONTRIBS_ENSURE_HOST
         PROCEDURE :: DEVICE_POINTER=> SOURCE_CONTRIBS_DEVICE_POINTER
         PROCEDURE :: INIT_UPDATE=> SOURCE_CONTRIBS_FIELD_INIT_UPDATE
#else
         PROCEDURE :: UPDATE_VIEW => SOURCE_CONTRIBS_UPDATE_VIEW
#endif
   END TYPE SOURCE_CONTRIBS_FIELD

   CONTAINS
      FUNCTION WRAP_2D_REAL_FIELD(ARR) RESULT(FIELD)
        REAL(KIND=JWRB), DIMENSION(:,:), INTENT(IN) :: ARR
         CLASS(FIELD_2D_WRAPPER), POINTER :: FIELD
         ALLOCATE(FIELD)
         CALL FIELD%INIT(ARR)
      END FUNCTION WRAP_2D_REAL_FIELD

      FUNCTION WRAP_3D_REAL_FIELD(ARR) RESULT(FIELD)
        REAL(KIND=JWRB), DIMENSION(:,:,:), INTENT(IN) :: ARR
         CLASS(FIELD_3D_WRAPPER), POINTER :: FIELD
         ALLOCATE(FIELD)
         CALL FIELD%INIT(ARR)
      END FUNCTION WRAP_3D_REAL_FIELD

      FUNCTION WRAP_4D_REAL_FIELD(ARR) RESULT(FIELD)
        REAL(KIND=JWRB), DIMENSION(:,:,:,:), INTENT(IN) :: ARR
         CLASS(FIELD_4D_WRAPPER), POINTER :: FIELD
         ALLOCATE(FIELD)
         CALL FIELD%INIT(ARR)
      END FUNCTION WRAP_4D_REAL_FIELD

      FUNCTION WRAP_2D_INT_FIELD(ARR) RESULT(FIELD)
        INTEGER(KIND=JWIM), DIMENSION(:,:), INTENT(IN) :: ARR
         CLASS(FIELD_INT2D_WRAPPER), POINTER :: FIELD
         ALLOCATE(FIELD)
         CALL FIELD%INIT(ARR)
      END FUNCTION WRAP_2D_INT_FIELD

      FUNCTION WRAP_3D_INT_FIELD(ARR) RESULT(FIELD)
        INTEGER(KIND=JWIM), DIMENSION(:,:,:), INTENT(IN) :: ARR
         CLASS(FIELD_INT3D_WRAPPER), POINTER :: FIELD
         ALLOCATE(FIELD)
         CALL FIELD%INIT(ARR)
      END FUNCTION WRAP_3D_INT_FIELD

      FUNCTION WRAP_4D_INT_FIELD(ARR) RESULT(FIELD)
        INTEGER(KIND=JWIM), DIMENSION(:,:,:,:), INTENT(IN) :: ARR
         CLASS(FIELD_INT4D_WRAPPER), POINTER :: FIELD
         ALLOCATE(FIELD)
         CALL FIELD%INIT(ARR)
      END FUNCTION WRAP_4D_INT_FIELD

      SUBROUTINE FREQUENCY_FIELD_INIT(SELF, WAVNUM, CINV, CGROUP, XK2CG, OMOSNH2KD, STOKFAC, CIWA,LFORCE)
          CLASS(FREQUENCY_FIELD), INTENT(INOUT) :: SELF
          REAL(KIND=JWRB), DIMENSION(:,:,:), INTENT(IN), OPTIONAL :: WAVNUM
          REAL(KIND=JWRB), DIMENSION(:,:,:), INTENT(IN), OPTIONAL :: CINV
          REAL(KIND=JWRB), DIMENSION(:,:,:), INTENT(IN), OPTIONAL :: CGROUP
          REAL(KIND=JWRB), DIMENSION(:,:,:), INTENT(IN), OPTIONAL :: XK2CG
          REAL(KIND=JWRB), DIMENSION(:,:,:), INTENT(IN), OPTIONAL :: OMOSNH2KD
          REAL(KIND=JWRB), DIMENSION(:,:,:), INTENT(IN), OPTIONAL :: STOKFAC
          REAL(KIND=JWRB), DIMENSION(:,:,:), INTENT(IN), OPTIONAL :: CIWA
          LOGICAL,INTENT(IN),OPTIONAL :: LFORCE ! force to allocate a new obj Yangjinhui 20230527
        
          IF(PRESENT(WAVNUM)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_WAVNUM) .OR. PRESENT(LFORCE)) SELF%F_WAVNUM => WRAP_3D_REAL_FIELD(WAVNUM)
          ENDIF
          IF(PRESENT(CINV)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_CINV) .OR. PRESENT(LFORCE)) SELF%F_CINV => WRAP_3D_REAL_FIELD(CINV)
          ENDIF
          IF(PRESENT(CGROUP)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_CGROUP) .OR. PRESENT(LFORCE)) SELF%F_CGROUP => WRAP_3D_REAL_FIELD(CGROUP)
          ENDIF
          IF(PRESENT(XK2CG)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_XK2CG) .OR. PRESENT(LFORCE)) SELF%F_XK2CG => WRAP_3D_REAL_FIELD(XK2CG)
          ENDIF
          IF(PRESENT(OMOSNH2KD)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_OMOSNH2KD) .OR. PRESENT(LFORCE)) SELF%F_OMOSNH2KD => WRAP_3D_REAL_FIELD(OMOSNH2KD)
          ENDIF
          IF(PRESENT(STOKFAC)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_STOKFAC) .OR. PRESENT(LFORCE)) SELF%F_STOKFAC => WRAP_3D_REAL_FIELD(STOKFAC)
          ENDIF
          IF(PRESENT(CIWA)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_CIWA) .OR. PRESENT(LFORCE)) SELF%F_CIWA => WRAP_3D_REAL_FIELD(CIWA)
          ENDIF
      END SUBROUTINE FREQUENCY_FIELD_INIT

      SUBROUTINE FREQUENCY_FIELD_INIT_UPDATE(SELF, WAVNUM, CINV, CGROUP, XK2CG, OMOSNH2KD, STOKFAC, CIWA)
          CLASS(FREQUENCY_FIELD), INTENT(INOUT) :: SELF
            REAL(KIND=JWRB),TARGET, DIMENSION(:,:,:), INTENT(IN), OPTIONAL :: WAVNUM
            REAL(KIND=JWRB),TARGET, DIMENSION(:,:,:), INTENT(IN), OPTIONAL :: CINV
            REAL(KIND=JWRB),TARGET, DIMENSION(:,:,:), INTENT(IN), OPTIONAL :: CGROUP
            REAL(KIND=JWRB),TARGET, DIMENSION(:,:,:), INTENT(IN), OPTIONAL :: XK2CG
            REAL(KIND=JWRB),TARGET, DIMENSION(:,:,:), INTENT(IN), OPTIONAL :: OMOSNH2KD
            REAL(KIND=JWRB),TARGET, DIMENSION(:,:,:), INTENT(IN), OPTIONAL :: STOKFAC
            REAL(KIND=JWRB),TARGET, DIMENSION(:,:,:), INTENT(IN), OPTIONAL :: CIWA
      
        IF(PRESENT(WAVNUM)) THEN
            IF(ASSOCIATED(SELF%F_WAVNUM)) THEN
                SELF%F_WAVNUM%PTR=>WAVNUM
            ELSE
                SELF%F_WAVNUM => WRAP_3D_REAL_FIELD(WAVNUM)
            ENDIF
            CALL SELF%F_WAVNUM%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
        IF(PRESENT(CINV)) THEN
            IF(ASSOCIATED(SELF%F_CINV)) THEN
                SELF%F_CINV%PTR=>CINV
            ELSE
                SELF%F_CINV => WRAP_3D_REAL_FIELD(CINV)
            ENDIF
            CALL SELF%F_CINV%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
        IF(PRESENT(CGROUP)) THEN
            IF(ASSOCIATED(SELF%F_CGROUP)) THEN
                SELF%F_CGROUP%PTR=>CGROUP
            ELSE
                SELF%F_CGROUP => WRAP_3D_REAL_FIELD(CGROUP)
            ENDIF
            CALL SELF%F_CGROUP%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
        IF(PRESENT(XK2CG)) THEN
            IF(ASSOCIATED(SELF%F_XK2CG)) THEN
                SELF%F_XK2CG%PTR=>XK2CG
            ELSE
                SELF%F_XK2CG => WRAP_3D_REAL_FIELD(XK2CG)
            ENDIF
            CALL SELF%F_XK2CG%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
        IF(PRESENT(OMOSNH2KD)) THEN
            IF(ASSOCIATED(SELF%F_OMOSNH2KD)) THEN
                SELF%F_OMOSNH2KD%PTR=>OMOSNH2KD
            ELSE
                SELF%F_OMOSNH2KD => WRAP_3D_REAL_FIELD(OMOSNH2KD)
            ENDIF
            CALL SELF%F_OMOSNH2KD%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
        IF(PRESENT(STOKFAC)) THEN
            IF(ASSOCIATED(SELF%F_STOKFAC)) THEN
                SELF%F_STOKFAC%PTR=>STOKFAC
            ELSE
                SELF%F_STOKFAC => WRAP_3D_REAL_FIELD(STOKFAC)
            ENDIF
            CALL SELF%F_STOKFAC%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
        IF(PRESENT(CIWA)) THEN
            IF(ASSOCIATED(SELF%F_CIWA)) THEN
                SELF%F_CIWA%PTR=>CIWA
            ELSE
                SELF%F_CIWA => WRAP_3D_REAL_FIELD(CIWA)
            ENDIF
            CALL SELF%F_CIWA%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
      END SUBROUTINE FREQUENCY_FIELD_INIT_UPDATE

#ifdef WAM_PHYS_GPU
      SUBROUTINE FREQUENCY_UPDATE_DEVICE(SELF, WAVNUM, CINV, CGROUP, XK2CG, OMOSNH2KD, STOKFAC, CIWA)
          CLASS(FREQUENCY_FIELD), INTENT(INOUT) :: SELF
          REAL(KIND=JWRB), DIMENSION(:,:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: WAVNUM
          REAL(KIND=JWRB), DIMENSION(:,:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: CINV
          REAL(KIND=JWRB), DIMENSION(:,:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: CGROUP
          REAL(KIND=JWRB), DIMENSION(:,:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: XK2CG
          REAL(KIND=JWRB), DIMENSION(:,:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: OMOSNH2KD
          REAL(KIND=JWRB), DIMENSION(:,:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: STOKFAC
          REAL(KIND=JWRB), DIMENSION(:,:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: CIWA

          IF(PRESENT(WAVNUM)) CALL SELF%F_WAVNUM%GET_DEVICE_DATA_RDWR(WAVNUM)
          IF(PRESENT(CINV)) CALL SELF%F_CINV%GET_DEVICE_DATA_RDWR(CINV)
          IF(PRESENT(CGROUP)) CALL SELF%F_CGROUP%GET_DEVICE_DATA_RDWR(CGROUP)
          IF(PRESENT(XK2CG)) CALL SELF%F_XK2CG%GET_DEVICE_DATA_RDWR(XK2CG)
          IF(PRESENT(OMOSNH2KD)) CALL SELF%F_OMOSNH2KD%GET_DEVICE_DATA_RDWR(OMOSNH2KD)
          IF(PRESENT(STOKFAC)) CALL SELF%F_STOKFAC%GET_DEVICE_DATA_RDWR(STOKFAC)
          IF(PRESENT(CIWA)) CALL SELF%F_CIWA%GET_DEVICE_DATA_RDWR(CIWA)
      END SUBROUTINE FREQUENCY_UPDATE_DEVICE

      SUBROUTINE FREQUENCY_ENSURE_HOST(SELF,LWAVNUM, LCINV, LCGROUP, LXK2CG, LOMOSNH2KD, LSTOKFAC, LCIWA,ICHNK)
          CLASS(FREQUENCY_FIELD), INTENT(INOUT) :: SELF
               LOGICAL,INTENT(IN),OPTIONAL :: LWAVNUM
               LOGICAL,INTENT(IN),OPTIONAL :: LCINV
               LOGICAL,INTENT(IN),OPTIONAL :: LCGROUP
               LOGICAL,INTENT(IN),OPTIONAL :: LXK2CG
               LOGICAL,INTENT(IN),OPTIONAL :: LOMOSNH2KD
               LOGICAL,INTENT(IN),OPTIONAL :: LSTOKFAC
               LOGICAL,INTENT(IN),OPTIONAL :: LCIWA
          INTEGER(KIND=JWIM),OPTIONAL,INTENT(IN):: ICHNK

          IF(PRESENT(LWAVNUM) .AND. ASSOCIATED(SELF%F_WAVNUM)) CALL SELF%F_WAVNUM%ENSURE_HOST(ICHNK)
          IF(PRESENT(LCINV) .AND. ASSOCIATED(SELF%F_CINV)) CALL SELF%F_CINV%ENSURE_HOST(ICHNK)
          IF(PRESENT(LCGROUP) .AND. ASSOCIATED(SELF%F_CGROUP)) CALL SELF%F_CGROUP%ENSURE_HOST(ICHNK)
          IF(PRESENT(LXK2CG) .AND. ASSOCIATED(SELF%F_XK2CG)) CALL SELF%F_XK2CG%ENSURE_HOST(ICHNK)
          IF(PRESENT(LOMOSNH2KD) .AND. ASSOCIATED(SELF%F_OMOSNH2KD)) CALL SELF%F_OMOSNH2KD%ENSURE_HOST(ICHNK)
          IF(PRESENT(LSTOKFAC) .AND. ASSOCIATED(SELF%F_STOKFAC)) CALL SELF%F_STOKFAC%ENSURE_HOST(ICHNK)
          IF(PRESENT(LCIWA) .AND. ASSOCIATED(SELF%F_CIWA)) CALL SELF%F_CIWA%ENSURE_HOST(ICHNK)
      END SUBROUTINE FREQUENCY_ENSURE_HOST
#else
      SUBROUTINE FREQUENCY_UPDATE_VIEW(SELF, BLOCK_INDEX)
          CLASS(FREQUENCY_FIELD), INTENT(INOUT) :: SELF
          INTEGER(KIND=JWIM), INTENT(IN) :: BLOCK_INDEX

          IF(ASSOCIATED(SELF%F_WAVNUM)) SELF%WAVNUM => SELF%F_WAVNUM%GET_VIEW(BLOCK_INDEX)
          IF(ASSOCIATED(SELF%F_CINV)) SELF%CINV => SELF%F_CINV%GET_VIEW(BLOCK_INDEX)
          IF(ASSOCIATED(SELF%F_CGROUP)) SELF%CGROUP => SELF%F_CGROUP%GET_VIEW(BLOCK_INDEX)
          IF(ASSOCIATED(SELF%F_XK2CG)) SELF%XK2CG => SELF%F_XK2CG%GET_VIEW(BLOCK_INDEX)
          IF(ASSOCIATED(SELF%F_OMOSNH2KD)) SELF%OMOSNH2KD => SELF%F_OMOSNH2KD%GET_VIEW(BLOCK_INDEX)
          IF(ASSOCIATED(SELF%F_STOKFAC)) SELF%STOKFAC => SELF%F_STOKFAC%GET_VIEW(BLOCK_INDEX)
          IF(ASSOCIATED(SELF%F_CIWA)) SELF%CIWA => SELF%F_CIWA%GET_VIEW(BLOCK_INDEX)
      END SUBROUTINE FREQUENCY_UPDATE_VIEW
#endif

      SUBROUTINE FREQUENCY_DEVICE_POINTER(SELF, WAVNUM, CINV, CGROUP, XK2CG, OMOSNH2KD, STOKFAC, CIWA)
          CLASS(FREQUENCY_FIELD), INTENT(INOUT) :: SELF
                REAL(KIND=JWRB), DIMENSION(:,:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: WAVNUM
                REAL(KIND=JWRB), DIMENSION(:,:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: CINV
                REAL(KIND=JWRB), DIMENSION(:,:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: CGROUP
                REAL(KIND=JWRB), DIMENSION(:,:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: XK2CG
                REAL(KIND=JWRB), DIMENSION(:,:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: OMOSNH2KD
                REAL(KIND=JWRB), DIMENSION(:,:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: STOKFAC
                REAL(KIND=JWRB), DIMENSION(:,:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: CIWA
      
            IF(PRESENT(WAVNUM)) WAVNUM=>SELF%F_WAVNUM%DEVPTR
            IF(PRESENT(CINV)) CINV=>SELF%F_CINV%DEVPTR
            IF(PRESENT(CGROUP)) CGROUP=>SELF%F_CGROUP%DEVPTR
            IF(PRESENT(XK2CG)) XK2CG=>SELF%F_XK2CG%DEVPTR
            IF(PRESENT(OMOSNH2KD)) OMOSNH2KD=>SELF%F_OMOSNH2KD%DEVPTR
            IF(PRESENT(STOKFAC)) STOKFAC=>SELF%F_STOKFAC%DEVPTR
            IF(PRESENT(CIWA)) CIWA=>SELF%F_CIWA%DEVPTR
      END SUBROUTINE FREQUENCY_DEVICE_POINTER

      SUBROUTINE ENVIRONMENT_FIELD_INIT(SELF, INDEP, IODP, IOBND, DELLAM1, COSPHM1, DEPTH, EMAXDPT, UCUR, VCUR,LFORCE)
          CLASS(ENVIRONMENT_FIELD), INTENT(INOUT) :: SELF
          INTEGER(KIND=JWIM), DIMENSION(:,:), INTENT(IN), OPTIONAL :: INDEP
          INTEGER(KIND=JWIM), DIMENSION(:,:), INTENT(IN), OPTIONAL :: IODP
          INTEGER(KIND=JWIM), DIMENSION(:,:), INTENT(IN), OPTIONAL :: IOBND
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(IN), OPTIONAL :: DELLAM1
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(IN), OPTIONAL :: COSPHM1
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(IN), OPTIONAL :: DEPTH
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(IN), OPTIONAL :: EMAXDPT
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(IN), OPTIONAL :: UCUR
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(IN), OPTIONAL :: VCUR
          LOGICAL,INTENT(IN),OPTIONAL :: LFORCE ! force to allocate a new obj Yangjinhui 20230527
        
          IF(PRESENT(INDEP)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_INDEP) .OR. PRESENT(LFORCE)) SELF%F_INDEP => WRAP_2D_INT_FIELD(INDEP)
          ENDIF
          IF(PRESENT(IODP)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_IODP) .OR. PRESENT(LFORCE)) SELF%F_IODP => WRAP_2D_INT_FIELD(IODP)
          ENDIF
          IF(PRESENT(IOBND)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_IOBND) .OR. PRESENT(LFORCE)) SELF%F_IOBND => WRAP_2D_INT_FIELD(IOBND)
          ENDIF
          IF(PRESENT(DELLAM1)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_DELLAM1) .OR. PRESENT(LFORCE)) SELF%F_DELLAM1 => WRAP_2D_REAL_FIELD(DELLAM1)
          ENDIF
          IF(PRESENT(COSPHM1)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_COSPHM1) .OR. PRESENT(LFORCE)) SELF%F_COSPHM1 => WRAP_2D_REAL_FIELD(COSPHM1)
          ENDIF
          IF(PRESENT(DEPTH)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_DEPTH) .OR. PRESENT(LFORCE)) SELF%F_DEPTH => WRAP_2D_REAL_FIELD(DEPTH)
          ENDIF
          IF(PRESENT(EMAXDPT)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_EMAXDPT) .OR. PRESENT(LFORCE)) SELF%F_EMAXDPT => WRAP_2D_REAL_FIELD(EMAXDPT)
          ENDIF
          IF(PRESENT(UCUR)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_UCUR) .OR. PRESENT(LFORCE)) SELF%F_UCUR => WRAP_2D_REAL_FIELD(UCUR)
          ENDIF
          IF(PRESENT(VCUR)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_VCUR) .OR. PRESENT(LFORCE)) SELF%F_VCUR => WRAP_2D_REAL_FIELD(VCUR)
          ENDIF
      END SUBROUTINE ENVIRONMENT_FIELD_INIT

      SUBROUTINE ENVIRONMENT_FIELD_INIT_UPDATE(SELF, INDEP, IODP, IOBND, DELLAM1, COSPHM1, DEPTH, EMAXDPT, UCUR, VCUR)
          CLASS(ENVIRONMENT_FIELD), INTENT(INOUT) :: SELF
            INTEGER(KIND=JWIM),TARGET, DIMENSION(:,:), INTENT(IN), OPTIONAL :: INDEP
            INTEGER(KIND=JWIM),TARGET, DIMENSION(:,:), INTENT(IN), OPTIONAL :: IODP
            INTEGER(KIND=JWIM),TARGET, DIMENSION(:,:), INTENT(IN), OPTIONAL :: IOBND
            REAL(KIND=JWRB),TARGET, DIMENSION(:,:), INTENT(IN), OPTIONAL :: DELLAM1
            REAL(KIND=JWRB),TARGET, DIMENSION(:,:), INTENT(IN), OPTIONAL :: COSPHM1
            REAL(KIND=JWRB),TARGET, DIMENSION(:,:), INTENT(IN), OPTIONAL :: DEPTH
            REAL(KIND=JWRB),TARGET, DIMENSION(:,:), INTENT(IN), OPTIONAL :: EMAXDPT
            REAL(KIND=JWRB),TARGET, DIMENSION(:,:), INTENT(IN), OPTIONAL :: UCUR
            REAL(KIND=JWRB),TARGET, DIMENSION(:,:), INTENT(IN), OPTIONAL :: VCUR
      
        IF(PRESENT(INDEP)) THEN
            IF(ASSOCIATED(SELF%F_INDEP)) THEN
                SELF%F_INDEP%PTR=>INDEP
            ELSE
                SELF%F_INDEP => WRAP_2D_INT_FIELD(INDEP)
            ENDIF
            CALL SELF%F_INDEP%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
        IF(PRESENT(IODP)) THEN
            IF(ASSOCIATED(SELF%F_IODP)) THEN
                SELF%F_IODP%PTR=>IODP
            ELSE
                SELF%F_IODP => WRAP_2D_INT_FIELD(IODP)
            ENDIF
            CALL SELF%F_IODP%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
        IF(PRESENT(IOBND)) THEN
            IF(ASSOCIATED(SELF%F_IOBND)) THEN
                SELF%F_IOBND%PTR=>IOBND
            ELSE
                SELF%F_IOBND => WRAP_2D_INT_FIELD(IOBND)
            ENDIF
            CALL SELF%F_IOBND%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
        IF(PRESENT(DELLAM1)) THEN
            IF(ASSOCIATED(SELF%F_DELLAM1)) THEN
                SELF%F_DELLAM1%PTR=>DELLAM1
            ELSE
                SELF%F_DELLAM1 => WRAP_2D_REAL_FIELD(DELLAM1)
            ENDIF
            CALL SELF%F_DELLAM1%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
        IF(PRESENT(COSPHM1)) THEN
            IF(ASSOCIATED(SELF%F_COSPHM1)) THEN
                SELF%F_COSPHM1%PTR=>COSPHM1
            ELSE
                SELF%F_COSPHM1 => WRAP_2D_REAL_FIELD(COSPHM1)
            ENDIF
            CALL SELF%F_COSPHM1%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
        IF(PRESENT(DEPTH)) THEN
            IF(ASSOCIATED(SELF%F_DEPTH)) THEN
                SELF%F_DEPTH%PTR=>DEPTH
            ELSE
                SELF%F_DEPTH => WRAP_2D_REAL_FIELD(DEPTH)
            ENDIF
            CALL SELF%F_DEPTH%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
        IF(PRESENT(EMAXDPT)) THEN
            IF(ASSOCIATED(SELF%F_EMAXDPT)) THEN
                SELF%F_EMAXDPT%PTR=>EMAXDPT
            ELSE
                SELF%F_EMAXDPT => WRAP_2D_REAL_FIELD(EMAXDPT)
            ENDIF
            CALL SELF%F_EMAXDPT%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
        IF(PRESENT(UCUR)) THEN
            IF(ASSOCIATED(SELF%F_UCUR)) THEN
                SELF%F_UCUR%PTR=>UCUR
            ELSE
                SELF%F_UCUR => WRAP_2D_REAL_FIELD(UCUR)
            ENDIF
            CALL SELF%F_UCUR%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
        IF(PRESENT(VCUR)) THEN
            IF(ASSOCIATED(SELF%F_VCUR)) THEN
                SELF%F_VCUR%PTR=>VCUR
            ELSE
                SELF%F_VCUR => WRAP_2D_REAL_FIELD(VCUR)
            ENDIF
            CALL SELF%F_VCUR%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
      END SUBROUTINE ENVIRONMENT_FIELD_INIT_UPDATE

#ifdef WAM_PHYS_GPU
      SUBROUTINE ENVIRONMENT_UPDATE_DEVICE(SELF, INDEP, IODP, IOBND, DELLAM1, COSPHM1, DEPTH, EMAXDPT, UCUR, VCUR)
          CLASS(ENVIRONMENT_FIELD), INTENT(INOUT) :: SELF
          INTEGER(KIND=JWIM), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: INDEP
          INTEGER(KIND=JWIM), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: IODP
          INTEGER(KIND=JWIM), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: IOBND
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: DELLAM1
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: COSPHM1
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: DEPTH
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: EMAXDPT
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: UCUR
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: VCUR

          IF(PRESENT(INDEP)) CALL SELF%F_INDEP%GET_DEVICE_DATA_RDWR(INDEP)
          IF(PRESENT(IODP)) CALL SELF%F_IODP%GET_DEVICE_DATA_RDWR(IODP)
          IF(PRESENT(IOBND)) CALL SELF%F_IOBND%GET_DEVICE_DATA_RDWR(IOBND)
          IF(PRESENT(DELLAM1)) CALL SELF%F_DELLAM1%GET_DEVICE_DATA_RDWR(DELLAM1)
          IF(PRESENT(COSPHM1)) CALL SELF%F_COSPHM1%GET_DEVICE_DATA_RDWR(COSPHM1)
          IF(PRESENT(DEPTH)) CALL SELF%F_DEPTH%GET_DEVICE_DATA_RDWR(DEPTH)
          IF(PRESENT(EMAXDPT)) CALL SELF%F_EMAXDPT%GET_DEVICE_DATA_RDWR(EMAXDPT)
          IF(PRESENT(UCUR)) CALL SELF%F_UCUR%GET_DEVICE_DATA_RDWR(UCUR)
          IF(PRESENT(VCUR)) CALL SELF%F_VCUR%GET_DEVICE_DATA_RDWR(VCUR)
      END SUBROUTINE ENVIRONMENT_UPDATE_DEVICE

      SUBROUTINE ENVIRONMENT_ENSURE_HOST(SELF,LINDEP, LIODP, LIOBND, LDELLAM1, LCOSPHM1, LDEPTH, LEMAXDPT, LUCUR, LVCUR,ICHNK)
          CLASS(ENVIRONMENT_FIELD), INTENT(INOUT) :: SELF
               LOGICAL,INTENT(IN),OPTIONAL :: LINDEP
               LOGICAL,INTENT(IN),OPTIONAL :: LIODP
               LOGICAL,INTENT(IN),OPTIONAL :: LIOBND
               LOGICAL,INTENT(IN),OPTIONAL :: LDELLAM1
               LOGICAL,INTENT(IN),OPTIONAL :: LCOSPHM1
               LOGICAL,INTENT(IN),OPTIONAL :: LDEPTH
               LOGICAL,INTENT(IN),OPTIONAL :: LEMAXDPT
               LOGICAL,INTENT(IN),OPTIONAL :: LUCUR
               LOGICAL,INTENT(IN),OPTIONAL :: LVCUR
          INTEGER(KIND=JWIM),OPTIONAL,INTENT(IN):: ICHNK

          IF(PRESENT(LINDEP) .AND. ASSOCIATED(SELF%F_INDEP)) CALL SELF%F_INDEP%ENSURE_HOST(ICHNK)
          IF(PRESENT(LIODP) .AND. ASSOCIATED(SELF%F_IODP)) CALL SELF%F_IODP%ENSURE_HOST(ICHNK)
          IF(PRESENT(LIOBND) .AND. ASSOCIATED(SELF%F_IOBND)) CALL SELF%F_IOBND%ENSURE_HOST(ICHNK)
          IF(PRESENT(LDELLAM1) .AND. ASSOCIATED(SELF%F_DELLAM1)) CALL SELF%F_DELLAM1%ENSURE_HOST(ICHNK)
          IF(PRESENT(LCOSPHM1) .AND. ASSOCIATED(SELF%F_COSPHM1)) CALL SELF%F_COSPHM1%ENSURE_HOST(ICHNK)
          IF(PRESENT(LDEPTH) .AND. ASSOCIATED(SELF%F_DEPTH)) CALL SELF%F_DEPTH%ENSURE_HOST(ICHNK)
          IF(PRESENT(LEMAXDPT) .AND. ASSOCIATED(SELF%F_EMAXDPT)) CALL SELF%F_EMAXDPT%ENSURE_HOST(ICHNK)
          IF(PRESENT(LUCUR) .AND. ASSOCIATED(SELF%F_UCUR)) CALL SELF%F_UCUR%ENSURE_HOST(ICHNK)
          IF(PRESENT(LVCUR) .AND. ASSOCIATED(SELF%F_VCUR)) CALL SELF%F_VCUR%ENSURE_HOST(ICHNK)
      END SUBROUTINE ENVIRONMENT_ENSURE_HOST
#else
      SUBROUTINE ENVIRONMENT_UPDATE_VIEW(SELF, BLOCK_INDEX)
          CLASS(ENVIRONMENT_FIELD), INTENT(INOUT) :: SELF
          INTEGER(KIND=JWIM), INTENT(IN) :: BLOCK_INDEX

          IF(ASSOCIATED(SELF%F_INDEP)) SELF%INDEP => SELF%F_INDEP%GET_VIEW(BLOCK_INDEX)
          IF(ASSOCIATED(SELF%F_IODP)) SELF%IODP => SELF%F_IODP%GET_VIEW(BLOCK_INDEX)
          IF(ASSOCIATED(SELF%F_IOBND)) SELF%IOBND => SELF%F_IOBND%GET_VIEW(BLOCK_INDEX)
          IF(ASSOCIATED(SELF%F_DELLAM1)) SELF%DELLAM1 => SELF%F_DELLAM1%GET_VIEW(BLOCK_INDEX)
          IF(ASSOCIATED(SELF%F_COSPHM1)) SELF%COSPHM1 => SELF%F_COSPHM1%GET_VIEW(BLOCK_INDEX)
          IF(ASSOCIATED(SELF%F_DEPTH)) SELF%DEPTH => SELF%F_DEPTH%GET_VIEW(BLOCK_INDEX)
          IF(ASSOCIATED(SELF%F_EMAXDPT)) SELF%EMAXDPT => SELF%F_EMAXDPT%GET_VIEW(BLOCK_INDEX)
          IF(ASSOCIATED(SELF%F_UCUR)) SELF%UCUR => SELF%F_UCUR%GET_VIEW(BLOCK_INDEX)
          IF(ASSOCIATED(SELF%F_VCUR)) SELF%VCUR => SELF%F_VCUR%GET_VIEW(BLOCK_INDEX)
      END SUBROUTINE ENVIRONMENT_UPDATE_VIEW
#endif

      SUBROUTINE ENVIRONMENT_DEVICE_POINTER(SELF, INDEP, IODP, IOBND, DELLAM1, COSPHM1, DEPTH, EMAXDPT, UCUR, VCUR)
          CLASS(ENVIRONMENT_FIELD), INTENT(INOUT) :: SELF
                INTEGER(KIND=JWIM), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: INDEP
                INTEGER(KIND=JWIM), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: IODP
                INTEGER(KIND=JWIM), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: IOBND
                REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: DELLAM1
                REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: COSPHM1
                REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: DEPTH
                REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: EMAXDPT
                REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: UCUR
                REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: VCUR
      
            IF(PRESENT(INDEP)) INDEP=>SELF%F_INDEP%DEVPTR
            IF(PRESENT(IODP)) IODP=>SELF%F_IODP%DEVPTR
            IF(PRESENT(IOBND)) IOBND=>SELF%F_IOBND%DEVPTR
            IF(PRESENT(DELLAM1)) DELLAM1=>SELF%F_DELLAM1%DEVPTR
            IF(PRESENT(COSPHM1)) COSPHM1=>SELF%F_COSPHM1%DEVPTR
            IF(PRESENT(DEPTH)) DEPTH=>SELF%F_DEPTH%DEVPTR
            IF(PRESENT(EMAXDPT)) EMAXDPT=>SELF%F_EMAXDPT%DEVPTR
            IF(PRESENT(UCUR)) UCUR=>SELF%F_UCUR%DEVPTR
            IF(PRESENT(VCUR)) VCUR=>SELF%F_VCUR%DEVPTR
      END SUBROUTINE ENVIRONMENT_DEVICE_POINTER

      SUBROUTINE FORCING_FIELDS_FIELD_INIT(SELF, UWND, VWND, AIRD, WSTAR, CICOVER, CITHICK, LKFR, UCUR, VCUR, WSWAVE, WDWAVE,&
          & UFRIC, TAUW, TAUWDIR, Z0M, Z0B, CHRNCK, XLON, YLAT,LFORCE)
          CLASS(FORCING_FIELDS_FIELD), INTENT(INOUT) :: SELF
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(IN), OPTIONAL :: UWND
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(IN), OPTIONAL :: VWND
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(IN), OPTIONAL :: AIRD
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(IN), OPTIONAL :: WSTAR
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(IN), OPTIONAL :: CICOVER
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(IN), OPTIONAL :: CITHICK
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(IN), OPTIONAL :: LKFR
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(IN), OPTIONAL :: UCUR
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(IN), OPTIONAL :: VCUR
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(IN), OPTIONAL :: WSWAVE
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(IN), OPTIONAL :: WDWAVE
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(IN), OPTIONAL :: UFRIC
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(IN), OPTIONAL :: TAUW
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(IN), OPTIONAL :: TAUWDIR
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(IN), OPTIONAL :: Z0M
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(IN), OPTIONAL :: Z0B
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(IN), OPTIONAL :: CHRNCK
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(IN), OPTIONAL :: XLON
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(IN), OPTIONAL :: YLAT
          LOGICAL,INTENT(IN),OPTIONAL :: LFORCE ! force to allocate a new obj Yangjinhui 20230527
        
          IF(PRESENT(UWND)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_UWND) .OR. PRESENT(LFORCE)) SELF%F_UWND => WRAP_2D_REAL_FIELD(UWND)
          ENDIF
          IF(PRESENT(VWND)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_VWND) .OR. PRESENT(LFORCE)) SELF%F_VWND => WRAP_2D_REAL_FIELD(VWND)
          ENDIF
          IF(PRESENT(AIRD)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_AIRD) .OR. PRESENT(LFORCE)) SELF%F_AIRD => WRAP_2D_REAL_FIELD(AIRD)
          ENDIF
          IF(PRESENT(WSTAR)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_WSTAR) .OR. PRESENT(LFORCE)) SELF%F_WSTAR => WRAP_2D_REAL_FIELD(WSTAR)
          ENDIF
          IF(PRESENT(CICOVER)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_CICOVER) .OR. PRESENT(LFORCE)) SELF%F_CICOVER => WRAP_2D_REAL_FIELD(CICOVER)
          ENDIF
          IF(PRESENT(CITHICK)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_CITHICK) .OR. PRESENT(LFORCE)) SELF%F_CITHICK => WRAP_2D_REAL_FIELD(CITHICK)
          ENDIF
          IF(PRESENT(LKFR)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_LKFR) .OR. PRESENT(LFORCE)) SELF%F_LKFR => WRAP_2D_REAL_FIELD(LKFR)
          ENDIF
          IF(PRESENT(UCUR)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_UCUR) .OR. PRESENT(LFORCE)) SELF%F_UCUR => WRAP_2D_REAL_FIELD(UCUR)
          ENDIF
          IF(PRESENT(VCUR)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_VCUR) .OR. PRESENT(LFORCE)) SELF%F_VCUR => WRAP_2D_REAL_FIELD(VCUR)
          ENDIF
          IF(PRESENT(WSWAVE)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_WSWAVE) .OR. PRESENT(LFORCE)) SELF%F_WSWAVE => WRAP_2D_REAL_FIELD(WSWAVE)
          ENDIF
          IF(PRESENT(WDWAVE)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_WDWAVE) .OR. PRESENT(LFORCE)) SELF%F_WDWAVE => WRAP_2D_REAL_FIELD(WDWAVE)
          ENDIF
          IF(PRESENT(UFRIC)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_UFRIC) .OR. PRESENT(LFORCE)) SELF%F_UFRIC => WRAP_2D_REAL_FIELD(UFRIC)
          ENDIF
          IF(PRESENT(TAUW)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_TAUW) .OR. PRESENT(LFORCE)) SELF%F_TAUW => WRAP_2D_REAL_FIELD(TAUW)
          ENDIF
          IF(PRESENT(TAUWDIR)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_TAUWDIR) .OR. PRESENT(LFORCE)) SELF%F_TAUWDIR => WRAP_2D_REAL_FIELD(TAUWDIR)
          ENDIF
          IF(PRESENT(Z0M)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_Z0M) .OR. PRESENT(LFORCE)) SELF%F_Z0M => WRAP_2D_REAL_FIELD(Z0M)
          ENDIF
          IF(PRESENT(Z0B)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_Z0B) .OR. PRESENT(LFORCE)) SELF%F_Z0B => WRAP_2D_REAL_FIELD(Z0B)
          ENDIF
          IF(PRESENT(CHRNCK)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_CHRNCK) .OR. PRESENT(LFORCE)) SELF%F_CHRNCK => WRAP_2D_REAL_FIELD(CHRNCK)
          ENDIF
          IF(PRESENT(XLON)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_XLON) .OR. PRESENT(LFORCE)) SELF%F_XLON => WRAP_2D_REAL_FIELD(XLON)
          ENDIF
          IF(PRESENT(YLAT)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_YLAT) .OR. PRESENT(LFORCE)) SELF%F_YLAT => WRAP_2D_REAL_FIELD(YLAT)
          ENDIF
      END SUBROUTINE FORCING_FIELDS_FIELD_INIT

      SUBROUTINE FORCING_FIELDS_FIELD_INIT_UPDATE(SELF, UWND, VWND, AIRD, WSTAR, CICOVER, CITHICK, LKFR, UCUR, VCUR, WSWAVE,&
          & WDWAVE, UFRIC, TAUW, TAUWDIR, Z0M, Z0B, CHRNCK, XLON, YLAT)
          CLASS(FORCING_FIELDS_FIELD), INTENT(INOUT) :: SELF
            REAL(KIND=JWRB),TARGET, DIMENSION(:,:), INTENT(IN), OPTIONAL :: UWND
            REAL(KIND=JWRB),TARGET, DIMENSION(:,:), INTENT(IN), OPTIONAL :: VWND
            REAL(KIND=JWRB),TARGET, DIMENSION(:,:), INTENT(IN), OPTIONAL :: AIRD
            REAL(KIND=JWRB),TARGET, DIMENSION(:,:), INTENT(IN), OPTIONAL :: WSTAR
            REAL(KIND=JWRB),TARGET, DIMENSION(:,:), INTENT(IN), OPTIONAL :: CICOVER
            REAL(KIND=JWRB),TARGET, DIMENSION(:,:), INTENT(IN), OPTIONAL :: CITHICK
            REAL(KIND=JWRB),TARGET, DIMENSION(:,:), INTENT(IN), OPTIONAL :: LKFR
            REAL(KIND=JWRB),TARGET, DIMENSION(:,:), INTENT(IN), OPTIONAL :: UCUR
            REAL(KIND=JWRB),TARGET, DIMENSION(:,:), INTENT(IN), OPTIONAL :: VCUR
            REAL(KIND=JWRB),TARGET, DIMENSION(:,:), INTENT(IN), OPTIONAL :: WSWAVE
            REAL(KIND=JWRB),TARGET, DIMENSION(:,:), INTENT(IN), OPTIONAL :: WDWAVE
            REAL(KIND=JWRB),TARGET, DIMENSION(:,:), INTENT(IN), OPTIONAL :: UFRIC
            REAL(KIND=JWRB),TARGET, DIMENSION(:,:), INTENT(IN), OPTIONAL :: TAUW
            REAL(KIND=JWRB),TARGET, DIMENSION(:,:), INTENT(IN), OPTIONAL :: TAUWDIR
            REAL(KIND=JWRB),TARGET, DIMENSION(:,:), INTENT(IN), OPTIONAL :: Z0M
            REAL(KIND=JWRB),TARGET, DIMENSION(:,:), INTENT(IN), OPTIONAL :: Z0B
            REAL(KIND=JWRB),TARGET, DIMENSION(:,:), INTENT(IN), OPTIONAL :: CHRNCK
            REAL(KIND=JWRB),TARGET, DIMENSION(:,:), INTENT(IN), OPTIONAL :: XLON
            REAL(KIND=JWRB),TARGET, DIMENSION(:,:), INTENT(IN), OPTIONAL :: YLAT
      
        IF(PRESENT(UWND)) THEN
            IF(ASSOCIATED(SELF%F_UWND)) THEN
                SELF%F_UWND%PTR=>UWND
            ELSE
                SELF%F_UWND => WRAP_2D_REAL_FIELD(UWND)
            ENDIF
            CALL SELF%F_UWND%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
        IF(PRESENT(VWND)) THEN
            IF(ASSOCIATED(SELF%F_VWND)) THEN
                SELF%F_VWND%PTR=>VWND
            ELSE
                SELF%F_VWND => WRAP_2D_REAL_FIELD(VWND)
            ENDIF
            CALL SELF%F_VWND%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
        IF(PRESENT(AIRD)) THEN
            IF(ASSOCIATED(SELF%F_AIRD)) THEN
                SELF%F_AIRD%PTR=>AIRD
            ELSE
                SELF%F_AIRD => WRAP_2D_REAL_FIELD(AIRD)
            ENDIF
            CALL SELF%F_AIRD%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
        IF(PRESENT(WSTAR)) THEN
            IF(ASSOCIATED(SELF%F_WSTAR)) THEN
                SELF%F_WSTAR%PTR=>WSTAR
            ELSE
                SELF%F_WSTAR => WRAP_2D_REAL_FIELD(WSTAR)
            ENDIF
            CALL SELF%F_WSTAR%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
        IF(PRESENT(CICOVER)) THEN
            IF(ASSOCIATED(SELF%F_CICOVER)) THEN
                SELF%F_CICOVER%PTR=>CICOVER
            ELSE
                SELF%F_CICOVER => WRAP_2D_REAL_FIELD(CICOVER)
            ENDIF
            CALL SELF%F_CICOVER%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
        IF(PRESENT(CITHICK)) THEN
            IF(ASSOCIATED(SELF%F_CITHICK)) THEN
                SELF%F_CITHICK%PTR=>CITHICK
            ELSE
                SELF%F_CITHICK => WRAP_2D_REAL_FIELD(CITHICK)
            ENDIF
            CALL SELF%F_CITHICK%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
        IF(PRESENT(LKFR)) THEN
            IF(ASSOCIATED(SELF%F_LKFR)) THEN
                SELF%F_LKFR%PTR=>LKFR
            ELSE
                SELF%F_LKFR => WRAP_2D_REAL_FIELD(LKFR)
            ENDIF
            CALL SELF%F_LKFR%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
        IF(PRESENT(UCUR)) THEN
            IF(ASSOCIATED(SELF%F_UCUR)) THEN
                SELF%F_UCUR%PTR=>UCUR
            ELSE
                SELF%F_UCUR => WRAP_2D_REAL_FIELD(UCUR)
            ENDIF
            CALL SELF%F_UCUR%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
        IF(PRESENT(VCUR)) THEN
            IF(ASSOCIATED(SELF%F_VCUR)) THEN
                SELF%F_VCUR%PTR=>VCUR
            ELSE
                SELF%F_VCUR => WRAP_2D_REAL_FIELD(VCUR)
            ENDIF
            CALL SELF%F_VCUR%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
        IF(PRESENT(WSWAVE)) THEN
            IF(ASSOCIATED(SELF%F_WSWAVE)) THEN
                SELF%F_WSWAVE%PTR=>WSWAVE
            ELSE
                SELF%F_WSWAVE => WRAP_2D_REAL_FIELD(WSWAVE)
            ENDIF
            CALL SELF%F_WSWAVE%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
        IF(PRESENT(WDWAVE)) THEN
            IF(ASSOCIATED(SELF%F_WDWAVE)) THEN
                SELF%F_WDWAVE%PTR=>WDWAVE
            ELSE
                SELF%F_WDWAVE => WRAP_2D_REAL_FIELD(WDWAVE)
            ENDIF
            CALL SELF%F_WDWAVE%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
        IF(PRESENT(UFRIC)) THEN
            IF(ASSOCIATED(SELF%F_UFRIC)) THEN
                SELF%F_UFRIC%PTR=>UFRIC
            ELSE
                SELF%F_UFRIC => WRAP_2D_REAL_FIELD(UFRIC)
            ENDIF
            CALL SELF%F_UFRIC%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
        IF(PRESENT(TAUW)) THEN
            IF(ASSOCIATED(SELF%F_TAUW)) THEN
                SELF%F_TAUW%PTR=>TAUW
            ELSE
                SELF%F_TAUW => WRAP_2D_REAL_FIELD(TAUW)
            ENDIF
            CALL SELF%F_TAUW%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
        IF(PRESENT(TAUWDIR)) THEN
            IF(ASSOCIATED(SELF%F_TAUWDIR)) THEN
                SELF%F_TAUWDIR%PTR=>TAUWDIR
            ELSE
                SELF%F_TAUWDIR => WRAP_2D_REAL_FIELD(TAUWDIR)
            ENDIF
            CALL SELF%F_TAUWDIR%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
        IF(PRESENT(Z0M)) THEN
            IF(ASSOCIATED(SELF%F_Z0M)) THEN
                SELF%F_Z0M%PTR=>Z0M
            ELSE
                SELF%F_Z0M => WRAP_2D_REAL_FIELD(Z0M)
            ENDIF
            CALL SELF%F_Z0M%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
        IF(PRESENT(Z0B)) THEN
            IF(ASSOCIATED(SELF%F_Z0B)) THEN
                SELF%F_Z0B%PTR=>Z0B
            ELSE
                SELF%F_Z0B => WRAP_2D_REAL_FIELD(Z0B)
            ENDIF
            CALL SELF%F_Z0B%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
        IF(PRESENT(CHRNCK)) THEN
            IF(ASSOCIATED(SELF%F_CHRNCK)) THEN
                SELF%F_CHRNCK%PTR=>CHRNCK
            ELSE
                SELF%F_CHRNCK => WRAP_2D_REAL_FIELD(CHRNCK)
            ENDIF
            CALL SELF%F_CHRNCK%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
        IF(PRESENT(XLON)) THEN
            IF(ASSOCIATED(SELF%F_XLON)) THEN
                SELF%F_XLON%PTR=>XLON
            ELSE
                SELF%F_XLON => WRAP_2D_REAL_FIELD(XLON)
            ENDIF
            CALL SELF%F_XLON%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
        IF(PRESENT(YLAT)) THEN
            IF(ASSOCIATED(SELF%F_YLAT)) THEN
                SELF%F_YLAT%PTR=>YLAT
            ELSE
                SELF%F_YLAT => WRAP_2D_REAL_FIELD(YLAT)
            ENDIF
            CALL SELF%F_YLAT%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
      END SUBROUTINE FORCING_FIELDS_FIELD_INIT_UPDATE

#ifdef WAM_PHYS_GPU
      SUBROUTINE FORCING_FIELDS_UPDATE_DEVICE(SELF, UWND, VWND, AIRD, WSTAR, CICOVER, CITHICK, LKFR, UCUR, VCUR, WSWAVE, WDWAVE,&
          & UFRIC, TAUW, TAUWDIR, Z0M, Z0B, CHRNCK, XLON, YLAT)
          CLASS(FORCING_FIELDS_FIELD), INTENT(INOUT) :: SELF
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: UWND
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: VWND
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: AIRD
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: WSTAR
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: CICOVER
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: CITHICK
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: LKFR
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: UCUR
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: VCUR
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: WSWAVE
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: WDWAVE
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: UFRIC
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: TAUW
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: TAUWDIR
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: Z0M
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: Z0B
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: CHRNCK
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: XLON
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: YLAT

          IF(PRESENT(UWND)) CALL SELF%F_UWND%GET_DEVICE_DATA_RDWR(UWND)
          IF(PRESENT(VWND)) CALL SELF%F_VWND%GET_DEVICE_DATA_RDWR(VWND)
          IF(PRESENT(AIRD)) CALL SELF%F_AIRD%GET_DEVICE_DATA_RDWR(AIRD)
          IF(PRESENT(WSTAR)) CALL SELF%F_WSTAR%GET_DEVICE_DATA_RDWR(WSTAR)
          IF(PRESENT(CICOVER)) CALL SELF%F_CICOVER%GET_DEVICE_DATA_RDWR(CICOVER)
          IF(PRESENT(CITHICK)) CALL SELF%F_CITHICK%GET_DEVICE_DATA_RDWR(CITHICK)
          IF(PRESENT(LKFR)) CALL SELF%F_LKFR%GET_DEVICE_DATA_RDWR(LKFR)
          IF(PRESENT(UCUR)) CALL SELF%F_UCUR%GET_DEVICE_DATA_RDWR(UCUR)
          IF(PRESENT(VCUR)) CALL SELF%F_VCUR%GET_DEVICE_DATA_RDWR(VCUR)
          IF(PRESENT(WSWAVE)) CALL SELF%F_WSWAVE%GET_DEVICE_DATA_RDWR(WSWAVE)
          IF(PRESENT(WDWAVE)) CALL SELF%F_WDWAVE%GET_DEVICE_DATA_RDWR(WDWAVE)
          IF(PRESENT(UFRIC)) CALL SELF%F_UFRIC%GET_DEVICE_DATA_RDWR(UFRIC)
          IF(PRESENT(TAUW)) CALL SELF%F_TAUW%GET_DEVICE_DATA_RDWR(TAUW)
          IF(PRESENT(TAUWDIR)) CALL SELF%F_TAUWDIR%GET_DEVICE_DATA_RDWR(TAUWDIR)
          IF(PRESENT(Z0M)) CALL SELF%F_Z0M%GET_DEVICE_DATA_RDWR(Z0M)
          IF(PRESENT(Z0B)) CALL SELF%F_Z0B%GET_DEVICE_DATA_RDWR(Z0B)
          IF(PRESENT(CHRNCK)) CALL SELF%F_CHRNCK%GET_DEVICE_DATA_RDWR(CHRNCK)
          IF(PRESENT(XLON)) CALL SELF%F_XLON%GET_DEVICE_DATA_RDWR(XLON)
          IF(PRESENT(YLAT)) CALL SELF%F_YLAT%GET_DEVICE_DATA_RDWR(YLAT)
      END SUBROUTINE FORCING_FIELDS_UPDATE_DEVICE

      SUBROUTINE FORCING_FIELDS_ENSURE_HOST(SELF,LUWND, LVWND, LAIRD, LWSTAR, LCICOVER, LCITHICK, LLKFR, LUCUR, LVCUR, LWSWAVE,&
          & LWDWAVE, LUFRIC, LTAUW, LTAUWDIR, LZ0M, LZ0B, LCHRNCK, LXLON, LYLAT,ICHNK)
          CLASS(FORCING_FIELDS_FIELD), INTENT(INOUT) :: SELF
               LOGICAL,INTENT(IN),OPTIONAL :: LUWND
               LOGICAL,INTENT(IN),OPTIONAL :: LVWND
               LOGICAL,INTENT(IN),OPTIONAL :: LAIRD
               LOGICAL,INTENT(IN),OPTIONAL :: LWSTAR
               LOGICAL,INTENT(IN),OPTIONAL :: LCICOVER
               LOGICAL,INTENT(IN),OPTIONAL :: LCITHICK
               LOGICAL,INTENT(IN),OPTIONAL :: LLKFR
               LOGICAL,INTENT(IN),OPTIONAL :: LUCUR
               LOGICAL,INTENT(IN),OPTIONAL :: LVCUR
               LOGICAL,INTENT(IN),OPTIONAL :: LWSWAVE
               LOGICAL,INTENT(IN),OPTIONAL :: LWDWAVE
               LOGICAL,INTENT(IN),OPTIONAL :: LUFRIC
               LOGICAL,INTENT(IN),OPTIONAL :: LTAUW
               LOGICAL,INTENT(IN),OPTIONAL :: LTAUWDIR
               LOGICAL,INTENT(IN),OPTIONAL :: LZ0M
               LOGICAL,INTENT(IN),OPTIONAL :: LZ0B
               LOGICAL,INTENT(IN),OPTIONAL :: LCHRNCK
               LOGICAL,INTENT(IN),OPTIONAL :: LXLON
               LOGICAL,INTENT(IN),OPTIONAL :: LYLAT
          INTEGER(KIND=JWIM),OPTIONAL,INTENT(IN):: ICHNK

          IF(PRESENT(LUWND) .AND. ASSOCIATED(SELF%F_UWND)) CALL SELF%F_UWND%ENSURE_HOST(ICHNK)
          IF(PRESENT(LVWND) .AND. ASSOCIATED(SELF%F_VWND)) CALL SELF%F_VWND%ENSURE_HOST(ICHNK)
          IF(PRESENT(LAIRD) .AND. ASSOCIATED(SELF%F_AIRD)) CALL SELF%F_AIRD%ENSURE_HOST(ICHNK)
          IF(PRESENT(LWSTAR) .AND. ASSOCIATED(SELF%F_WSTAR)) CALL SELF%F_WSTAR%ENSURE_HOST(ICHNK)
          IF(PRESENT(LCICOVER) .AND. ASSOCIATED(SELF%F_CICOVER)) CALL SELF%F_CICOVER%ENSURE_HOST(ICHNK)
          IF(PRESENT(LCITHICK) .AND. ASSOCIATED(SELF%F_CITHICK)) CALL SELF%F_CITHICK%ENSURE_HOST(ICHNK)
          IF(PRESENT(LLKFR) .AND. ASSOCIATED(SELF%F_LKFR)) CALL SELF%F_LKFR%ENSURE_HOST(ICHNK)
          IF(PRESENT(LUCUR) .AND. ASSOCIATED(SELF%F_UCUR)) CALL SELF%F_UCUR%ENSURE_HOST(ICHNK)
          IF(PRESENT(LVCUR) .AND. ASSOCIATED(SELF%F_VCUR)) CALL SELF%F_VCUR%ENSURE_HOST(ICHNK)
          IF(PRESENT(LWSWAVE) .AND. ASSOCIATED(SELF%F_WSWAVE)) CALL SELF%F_WSWAVE%ENSURE_HOST(ICHNK)
          IF(PRESENT(LWDWAVE) .AND. ASSOCIATED(SELF%F_WDWAVE)) CALL SELF%F_WDWAVE%ENSURE_HOST(ICHNK)
          IF(PRESENT(LUFRIC) .AND. ASSOCIATED(SELF%F_UFRIC)) CALL SELF%F_UFRIC%ENSURE_HOST(ICHNK)
          IF(PRESENT(LTAUW) .AND. ASSOCIATED(SELF%F_TAUW)) CALL SELF%F_TAUW%ENSURE_HOST(ICHNK)
          IF(PRESENT(LTAUWDIR) .AND. ASSOCIATED(SELF%F_TAUWDIR)) CALL SELF%F_TAUWDIR%ENSURE_HOST(ICHNK)
          IF(PRESENT(LZ0M) .AND. ASSOCIATED(SELF%F_Z0M)) CALL SELF%F_Z0M%ENSURE_HOST(ICHNK)
          IF(PRESENT(LZ0B) .AND. ASSOCIATED(SELF%F_Z0B)) CALL SELF%F_Z0B%ENSURE_HOST(ICHNK)
          IF(PRESENT(LCHRNCK) .AND. ASSOCIATED(SELF%F_CHRNCK)) CALL SELF%F_CHRNCK%ENSURE_HOST(ICHNK)
          IF(PRESENT(LXLON) .AND. ASSOCIATED(SELF%F_XLON)) CALL SELF%F_XLON%ENSURE_HOST(ICHNK)
          IF(PRESENT(LYLAT) .AND. ASSOCIATED(SELF%F_YLAT)) CALL SELF%F_YLAT%ENSURE_HOST(ICHNK)
      END SUBROUTINE FORCING_FIELDS_ENSURE_HOST
#else
      SUBROUTINE FORCING_FIELDS_UPDATE_VIEW(SELF, BLOCK_INDEX)
          CLASS(FORCING_FIELDS_FIELD), INTENT(INOUT) :: SELF
          INTEGER(KIND=JWIM), INTENT(IN) :: BLOCK_INDEX

          IF(ASSOCIATED(SELF%F_UWND)) SELF%UWND => SELF%F_UWND%GET_VIEW(BLOCK_INDEX)
          IF(ASSOCIATED(SELF%F_VWND)) SELF%VWND => SELF%F_VWND%GET_VIEW(BLOCK_INDEX)
          IF(ASSOCIATED(SELF%F_AIRD)) SELF%AIRD => SELF%F_AIRD%GET_VIEW(BLOCK_INDEX)
          IF(ASSOCIATED(SELF%F_WSTAR)) SELF%WSTAR => SELF%F_WSTAR%GET_VIEW(BLOCK_INDEX)
          IF(ASSOCIATED(SELF%F_CICOVER)) SELF%CICOVER => SELF%F_CICOVER%GET_VIEW(BLOCK_INDEX)
          IF(ASSOCIATED(SELF%F_CITHICK)) SELF%CITHICK => SELF%F_CITHICK%GET_VIEW(BLOCK_INDEX)
          IF(ASSOCIATED(SELF%F_LKFR)) SELF%LKFR => SELF%F_LKFR%GET_VIEW(BLOCK_INDEX)
          IF(ASSOCIATED(SELF%F_UCUR)) SELF%UCUR => SELF%F_UCUR%GET_VIEW(BLOCK_INDEX)
          IF(ASSOCIATED(SELF%F_VCUR)) SELF%VCUR => SELF%F_VCUR%GET_VIEW(BLOCK_INDEX)
          IF(ASSOCIATED(SELF%F_WSWAVE)) SELF%WSWAVE => SELF%F_WSWAVE%GET_VIEW(BLOCK_INDEX)
          IF(ASSOCIATED(SELF%F_WDWAVE)) SELF%WDWAVE => SELF%F_WDWAVE%GET_VIEW(BLOCK_INDEX)
          IF(ASSOCIATED(SELF%F_UFRIC)) SELF%UFRIC => SELF%F_UFRIC%GET_VIEW(BLOCK_INDEX)
          IF(ASSOCIATED(SELF%F_TAUW)) SELF%TAUW => SELF%F_TAUW%GET_VIEW(BLOCK_INDEX)
          IF(ASSOCIATED(SELF%F_TAUWDIR)) SELF%TAUWDIR => SELF%F_TAUWDIR%GET_VIEW(BLOCK_INDEX)
          IF(ASSOCIATED(SELF%F_Z0M)) SELF%Z0M => SELF%F_Z0M%GET_VIEW(BLOCK_INDEX)
          IF(ASSOCIATED(SELF%F_Z0B)) SELF%Z0B => SELF%F_Z0B%GET_VIEW(BLOCK_INDEX)
          IF(ASSOCIATED(SELF%F_CHRNCK)) SELF%CHRNCK => SELF%F_CHRNCK%GET_VIEW(BLOCK_INDEX)
          IF(ASSOCIATED(SELF%F_XLON)) SELF%XLON => SELF%F_XLON%GET_VIEW(BLOCK_INDEX)
          IF(ASSOCIATED(SELF%F_YLAT)) SELF%YLAT => SELF%F_YLAT%GET_VIEW(BLOCK_INDEX)
      END SUBROUTINE FORCING_FIELDS_UPDATE_VIEW
#endif

      SUBROUTINE FORCING_FIELDS_DEVICE_POINTER(SELF, UWND, VWND, AIRD, WSTAR, CICOVER, CITHICK, LKFR, UCUR, VCUR, WSWAVE, WDWAVE,&
          & UFRIC, TAUW, TAUWDIR, Z0M, Z0B, CHRNCK, XLON, YLAT)
          CLASS(FORCING_FIELDS_FIELD), INTENT(INOUT) :: SELF
                REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: UWND
                REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: VWND
                REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: AIRD
                REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: WSTAR
                REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: CICOVER
                REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: CITHICK
                REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: LKFR
                REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: UCUR
                REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: VCUR
                REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: WSWAVE
                REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: WDWAVE
                REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: UFRIC
                REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: TAUW
                REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: TAUWDIR
                REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: Z0M
                REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: Z0B
                REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: CHRNCK
                REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: XLON
                REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: YLAT
      
            IF(PRESENT(UWND)) UWND=>SELF%F_UWND%DEVPTR
            IF(PRESENT(VWND)) VWND=>SELF%F_VWND%DEVPTR
            IF(PRESENT(AIRD)) AIRD=>SELF%F_AIRD%DEVPTR
            IF(PRESENT(WSTAR)) WSTAR=>SELF%F_WSTAR%DEVPTR
            IF(PRESENT(CICOVER)) CICOVER=>SELF%F_CICOVER%DEVPTR
            IF(PRESENT(CITHICK)) CITHICK=>SELF%F_CITHICK%DEVPTR
            IF(PRESENT(LKFR)) LKFR=>SELF%F_LKFR%DEVPTR
            IF(PRESENT(UCUR)) UCUR=>SELF%F_UCUR%DEVPTR
            IF(PRESENT(VCUR)) VCUR=>SELF%F_VCUR%DEVPTR
            IF(PRESENT(WSWAVE)) WSWAVE=>SELF%F_WSWAVE%DEVPTR
            IF(PRESENT(WDWAVE)) WDWAVE=>SELF%F_WDWAVE%DEVPTR
            IF(PRESENT(UFRIC)) UFRIC=>SELF%F_UFRIC%DEVPTR
            IF(PRESENT(TAUW)) TAUW=>SELF%F_TAUW%DEVPTR
            IF(PRESENT(TAUWDIR)) TAUWDIR=>SELF%F_TAUWDIR%DEVPTR
            IF(PRESENT(Z0M)) Z0M=>SELF%F_Z0M%DEVPTR
            IF(PRESENT(Z0B)) Z0B=>SELF%F_Z0B%DEVPTR
            IF(PRESENT(CHRNCK)) CHRNCK=>SELF%F_CHRNCK%DEVPTR
            IF(PRESENT(XLON)) XLON=>SELF%F_XLON%DEVPTR
            IF(PRESENT(YLAT)) YLAT=>SELF%F_YLAT%DEVPTR
      END SUBROUTINE FORCING_FIELDS_DEVICE_POINTER

      SUBROUTINE WAVE2OCEAN_FIELD_INIT(SELF, NSWH, NMWP, NPHIEPS, NEMOPHIF, NTAUOC, NEMOTAUX, NEMOTAUY, NEMOUSTOKES, NEMOVSTOKES,&
          & NEMOSTRN, NEMOWSWAVE,LFORCE)
          CLASS(WAVE2OCEAN_FIELD), INTENT(INOUT) :: SELF
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(IN), OPTIONAL :: NSWH
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(IN), OPTIONAL :: NMWP
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(IN), OPTIONAL :: NPHIEPS
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(IN), OPTIONAL :: NEMOPHIF
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(IN), OPTIONAL :: NTAUOC
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(IN), OPTIONAL :: NEMOTAUX
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(IN), OPTIONAL :: NEMOTAUY
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(IN), OPTIONAL :: NEMOUSTOKES
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(IN), OPTIONAL :: NEMOVSTOKES
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(IN), OPTIONAL :: NEMOSTRN
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(IN), OPTIONAL :: NEMOWSWAVE
          LOGICAL,INTENT(IN),OPTIONAL :: LFORCE ! force to allocate a new obj Yangjinhui 20230527
        
          IF(PRESENT(NSWH)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_NSWH) .OR. PRESENT(LFORCE)) SELF%F_NSWH => WRAP_2D_REAL_FIELD(NSWH)
          ENDIF
          IF(PRESENT(NMWP)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_NMWP) .OR. PRESENT(LFORCE)) SELF%F_NMWP => WRAP_2D_REAL_FIELD(NMWP)
          ENDIF
          IF(PRESENT(NPHIEPS)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_NPHIEPS) .OR. PRESENT(LFORCE)) SELF%F_NPHIEPS => WRAP_2D_REAL_FIELD(NPHIEPS)
          ENDIF
          IF(PRESENT(NEMOPHIF)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_NEMOPHIF) .OR. PRESENT(LFORCE)) SELF%F_NEMOPHIF => WRAP_2D_REAL_FIELD(NEMOPHIF)
          ENDIF
          IF(PRESENT(NTAUOC)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_NTAUOC) .OR. PRESENT(LFORCE)) SELF%F_NTAUOC => WRAP_2D_REAL_FIELD(NTAUOC)
          ENDIF
          IF(PRESENT(NEMOTAUX)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_NEMOTAUX) .OR. PRESENT(LFORCE)) SELF%F_NEMOTAUX => WRAP_2D_REAL_FIELD(NEMOTAUX)
          ENDIF
          IF(PRESENT(NEMOTAUY)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_NEMOTAUY) .OR. PRESENT(LFORCE)) SELF%F_NEMOTAUY => WRAP_2D_REAL_FIELD(NEMOTAUY)
          ENDIF
          IF(PRESENT(NEMOUSTOKES)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_NEMOUSTOKES) .OR. PRESENT(LFORCE)) SELF%F_NEMOUSTOKES => WRAP_2D_REAL_FIELD(NEMOUSTOKES)
          ENDIF
          IF(PRESENT(NEMOVSTOKES)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_NEMOVSTOKES) .OR. PRESENT(LFORCE)) SELF%F_NEMOVSTOKES => WRAP_2D_REAL_FIELD(NEMOVSTOKES)
          ENDIF
          IF(PRESENT(NEMOSTRN)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_NEMOSTRN) .OR. PRESENT(LFORCE)) SELF%F_NEMOSTRN => WRAP_2D_REAL_FIELD(NEMOSTRN)
          ENDIF
          IF(PRESENT(NEMOWSWAVE)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_NEMOWSWAVE) .OR. PRESENT(LFORCE)) SELF%F_NEMOWSWAVE => WRAP_2D_REAL_FIELD(NEMOWSWAVE)
          ENDIF
      END SUBROUTINE WAVE2OCEAN_FIELD_INIT

      SUBROUTINE WAVE2OCEAN_FIELD_INIT_UPDATE(SELF, NSWH, NMWP, NPHIEPS, NEMOPHIF, NTAUOC, NEMOTAUX, NEMOTAUY, NEMOUSTOKES,&
          & NEMOVSTOKES, NEMOSTRN, NEMOWSWAVE)
          CLASS(WAVE2OCEAN_FIELD), INTENT(INOUT) :: SELF
            REAL(KIND=JWRB),TARGET, DIMENSION(:,:), INTENT(IN), OPTIONAL :: NSWH
            REAL(KIND=JWRB),TARGET, DIMENSION(:,:), INTENT(IN), OPTIONAL :: NMWP
            REAL(KIND=JWRB),TARGET, DIMENSION(:,:), INTENT(IN), OPTIONAL :: NPHIEPS
            REAL(KIND=JWRB),TARGET, DIMENSION(:,:), INTENT(IN), OPTIONAL :: NEMOPHIF
            REAL(KIND=JWRB),TARGET, DIMENSION(:,:), INTENT(IN), OPTIONAL :: NTAUOC
            REAL(KIND=JWRB),TARGET, DIMENSION(:,:), INTENT(IN), OPTIONAL :: NEMOTAUX
            REAL(KIND=JWRB),TARGET, DIMENSION(:,:), INTENT(IN), OPTIONAL :: NEMOTAUY
            REAL(KIND=JWRB),TARGET, DIMENSION(:,:), INTENT(IN), OPTIONAL :: NEMOUSTOKES
            REAL(KIND=JWRB),TARGET, DIMENSION(:,:), INTENT(IN), OPTIONAL :: NEMOVSTOKES
            REAL(KIND=JWRB),TARGET, DIMENSION(:,:), INTENT(IN), OPTIONAL :: NEMOSTRN
            REAL(KIND=JWRB),TARGET, DIMENSION(:,:), INTENT(IN), OPTIONAL :: NEMOWSWAVE
      
        IF(PRESENT(NSWH)) THEN
            IF(ASSOCIATED(SELF%F_NSWH)) THEN
                SELF%F_NSWH%PTR=>NSWH
            ELSE
                SELF%F_NSWH => WRAP_2D_REAL_FIELD(NSWH)
            ENDIF
            CALL SELF%F_NSWH%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
        IF(PRESENT(NMWP)) THEN
            IF(ASSOCIATED(SELF%F_NMWP)) THEN
                SELF%F_NMWP%PTR=>NMWP
            ELSE
                SELF%F_NMWP => WRAP_2D_REAL_FIELD(NMWP)
            ENDIF
            CALL SELF%F_NMWP%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
        IF(PRESENT(NPHIEPS)) THEN
            IF(ASSOCIATED(SELF%F_NPHIEPS)) THEN
                SELF%F_NPHIEPS%PTR=>NPHIEPS
            ELSE
                SELF%F_NPHIEPS => WRAP_2D_REAL_FIELD(NPHIEPS)
            ENDIF
            CALL SELF%F_NPHIEPS%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
        IF(PRESENT(NEMOPHIF)) THEN
            IF(ASSOCIATED(SELF%F_NEMOPHIF)) THEN
                SELF%F_NEMOPHIF%PTR=>NEMOPHIF
            ELSE
                SELF%F_NEMOPHIF => WRAP_2D_REAL_FIELD(NEMOPHIF)
            ENDIF
            CALL SELF%F_NEMOPHIF%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
        IF(PRESENT(NTAUOC)) THEN
            IF(ASSOCIATED(SELF%F_NTAUOC)) THEN
                SELF%F_NTAUOC%PTR=>NTAUOC
            ELSE
                SELF%F_NTAUOC => WRAP_2D_REAL_FIELD(NTAUOC)
            ENDIF
            CALL SELF%F_NTAUOC%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
        IF(PRESENT(NEMOTAUX)) THEN
            IF(ASSOCIATED(SELF%F_NEMOTAUX)) THEN
                SELF%F_NEMOTAUX%PTR=>NEMOTAUX
            ELSE
                SELF%F_NEMOTAUX => WRAP_2D_REAL_FIELD(NEMOTAUX)
            ENDIF
            CALL SELF%F_NEMOTAUX%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
        IF(PRESENT(NEMOTAUY)) THEN
            IF(ASSOCIATED(SELF%F_NEMOTAUY)) THEN
                SELF%F_NEMOTAUY%PTR=>NEMOTAUY
            ELSE
                SELF%F_NEMOTAUY => WRAP_2D_REAL_FIELD(NEMOTAUY)
            ENDIF
            CALL SELF%F_NEMOTAUY%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
        IF(PRESENT(NEMOUSTOKES)) THEN
            IF(ASSOCIATED(SELF%F_NEMOUSTOKES)) THEN
                SELF%F_NEMOUSTOKES%PTR=>NEMOUSTOKES
            ELSE
                SELF%F_NEMOUSTOKES => WRAP_2D_REAL_FIELD(NEMOUSTOKES)
            ENDIF
            CALL SELF%F_NEMOUSTOKES%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
        IF(PRESENT(NEMOVSTOKES)) THEN
            IF(ASSOCIATED(SELF%F_NEMOVSTOKES)) THEN
                SELF%F_NEMOVSTOKES%PTR=>NEMOVSTOKES
            ELSE
                SELF%F_NEMOVSTOKES => WRAP_2D_REAL_FIELD(NEMOVSTOKES)
            ENDIF
            CALL SELF%F_NEMOVSTOKES%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
        IF(PRESENT(NEMOSTRN)) THEN
            IF(ASSOCIATED(SELF%F_NEMOSTRN)) THEN
                SELF%F_NEMOSTRN%PTR=>NEMOSTRN
            ELSE
                SELF%F_NEMOSTRN => WRAP_2D_REAL_FIELD(NEMOSTRN)
            ENDIF
            CALL SELF%F_NEMOSTRN%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
        IF(PRESENT(NEMOWSWAVE)) THEN
            IF(ASSOCIATED(SELF%F_NEMOWSWAVE)) THEN
                SELF%F_NEMOWSWAVE%PTR=>NEMOWSWAVE
            ELSE
                SELF%F_NEMOWSWAVE => WRAP_2D_REAL_FIELD(NEMOWSWAVE)
            ENDIF
            CALL SELF%F_NEMOWSWAVE%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
      END SUBROUTINE WAVE2OCEAN_FIELD_INIT_UPDATE

#ifdef WAM_PHYS_GPU
      SUBROUTINE WAVE2OCEAN_UPDATE_DEVICE(SELF, NSWH, NMWP, NPHIEPS, NEMOPHIF, NTAUOC, NEMOTAUX, NEMOTAUY, NEMOUSTOKES,&
          & NEMOVSTOKES, NEMOSTRN, NEMOWSWAVE)
          CLASS(WAVE2OCEAN_FIELD), INTENT(INOUT) :: SELF
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: NSWH
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: NMWP
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: NPHIEPS
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: NEMOPHIF
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: NTAUOC
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: NEMOTAUX
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: NEMOTAUY
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: NEMOUSTOKES
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: NEMOVSTOKES
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: NEMOSTRN
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: NEMOWSWAVE

          IF(PRESENT(NSWH)) CALL SELF%F_NSWH%GET_DEVICE_DATA_RDWR(NSWH)
          IF(PRESENT(NMWP)) CALL SELF%F_NMWP%GET_DEVICE_DATA_RDWR(NMWP)
          IF(PRESENT(NPHIEPS)) CALL SELF%F_NPHIEPS%GET_DEVICE_DATA_RDWR(NPHIEPS)
          IF(PRESENT(NEMOPHIF)) CALL SELF%F_NEMOPHIF%GET_DEVICE_DATA_RDWR(NEMOPHIF)
          IF(PRESENT(NTAUOC)) CALL SELF%F_NTAUOC%GET_DEVICE_DATA_RDWR(NTAUOC)
          IF(PRESENT(NEMOTAUX)) CALL SELF%F_NEMOTAUX%GET_DEVICE_DATA_RDWR(NEMOTAUX)
          IF(PRESENT(NEMOTAUY)) CALL SELF%F_NEMOTAUY%GET_DEVICE_DATA_RDWR(NEMOTAUY)
          IF(PRESENT(NEMOUSTOKES)) CALL SELF%F_NEMOUSTOKES%GET_DEVICE_DATA_RDWR(NEMOUSTOKES)
          IF(PRESENT(NEMOVSTOKES)) CALL SELF%F_NEMOVSTOKES%GET_DEVICE_DATA_RDWR(NEMOVSTOKES)
          IF(PRESENT(NEMOSTRN)) CALL SELF%F_NEMOSTRN%GET_DEVICE_DATA_RDWR(NEMOSTRN)
          IF(PRESENT(NEMOWSWAVE)) CALL SELF%F_NEMOWSWAVE%GET_DEVICE_DATA_RDWR(NEMOWSWAVE)
      END SUBROUTINE WAVE2OCEAN_UPDATE_DEVICE

      SUBROUTINE WAVE2OCEAN_ENSURE_HOST(SELF,LNSWH, LNMWP, LNPHIEPS, LNEMOPHIF, LNTAUOC, LNEMOTAUX, LNEMOTAUY, LNEMOUSTOKES,&
          & LNEMOVSTOKES, LNEMOSTRN, LNEMOWSWAVE,ICHNK)
          CLASS(WAVE2OCEAN_FIELD), INTENT(INOUT) :: SELF
               LOGICAL,INTENT(IN),OPTIONAL :: LNSWH
               LOGICAL,INTENT(IN),OPTIONAL :: LNMWP
               LOGICAL,INTENT(IN),OPTIONAL :: LNPHIEPS
               LOGICAL,INTENT(IN),OPTIONAL :: LNEMOPHIF
               LOGICAL,INTENT(IN),OPTIONAL :: LNTAUOC
               LOGICAL,INTENT(IN),OPTIONAL :: LNEMOTAUX
               LOGICAL,INTENT(IN),OPTIONAL :: LNEMOTAUY
               LOGICAL,INTENT(IN),OPTIONAL :: LNEMOUSTOKES
               LOGICAL,INTENT(IN),OPTIONAL :: LNEMOVSTOKES
               LOGICAL,INTENT(IN),OPTIONAL :: LNEMOSTRN
               LOGICAL,INTENT(IN),OPTIONAL :: LNEMOWSWAVE
          INTEGER(KIND=JWIM),OPTIONAL,INTENT(IN):: ICHNK

          IF(PRESENT(LNSWH) .AND. ASSOCIATED(SELF%F_NSWH)) CALL SELF%F_NSWH%ENSURE_HOST(ICHNK)
          IF(PRESENT(LNMWP) .AND. ASSOCIATED(SELF%F_NMWP)) CALL SELF%F_NMWP%ENSURE_HOST(ICHNK)
          IF(PRESENT(LNPHIEPS) .AND. ASSOCIATED(SELF%F_NPHIEPS)) CALL SELF%F_NPHIEPS%ENSURE_HOST(ICHNK)
          IF(PRESENT(LNEMOPHIF) .AND. ASSOCIATED(SELF%F_NEMOPHIF)) CALL SELF%F_NEMOPHIF%ENSURE_HOST(ICHNK)
          IF(PRESENT(LNTAUOC) .AND. ASSOCIATED(SELF%F_NTAUOC)) CALL SELF%F_NTAUOC%ENSURE_HOST(ICHNK)
          IF(PRESENT(LNEMOTAUX) .AND. ASSOCIATED(SELF%F_NEMOTAUX)) CALL SELF%F_NEMOTAUX%ENSURE_HOST(ICHNK)
          IF(PRESENT(LNEMOTAUY) .AND. ASSOCIATED(SELF%F_NEMOTAUY)) CALL SELF%F_NEMOTAUY%ENSURE_HOST(ICHNK)
          IF(PRESENT(LNEMOUSTOKES) .AND. ASSOCIATED(SELF%F_NEMOUSTOKES)) CALL SELF%F_NEMOUSTOKES%ENSURE_HOST(ICHNK)
          IF(PRESENT(LNEMOVSTOKES) .AND. ASSOCIATED(SELF%F_NEMOVSTOKES)) CALL SELF%F_NEMOVSTOKES%ENSURE_HOST(ICHNK)
          IF(PRESENT(LNEMOSTRN) .AND. ASSOCIATED(SELF%F_NEMOSTRN)) CALL SELF%F_NEMOSTRN%ENSURE_HOST(ICHNK)
          IF(PRESENT(LNEMOWSWAVE) .AND. ASSOCIATED(SELF%F_NEMOWSWAVE)) CALL SELF%F_NEMOWSWAVE%ENSURE_HOST(ICHNK)
      END SUBROUTINE WAVE2OCEAN_ENSURE_HOST
#else
      SUBROUTINE WAVE2OCEAN_UPDATE_VIEW(SELF, BLOCK_INDEX)
          CLASS(WAVE2OCEAN_FIELD), INTENT(INOUT) :: SELF
          INTEGER(KIND=JWIM), INTENT(IN) :: BLOCK_INDEX

          IF(ASSOCIATED(SELF%F_NSWH)) SELF%NSWH => SELF%F_NSWH%GET_VIEW(BLOCK_INDEX)
          IF(ASSOCIATED(SELF%F_NMWP)) SELF%NMWP => SELF%F_NMWP%GET_VIEW(BLOCK_INDEX)
          IF(ASSOCIATED(SELF%F_NPHIEPS)) SELF%NPHIEPS => SELF%F_NPHIEPS%GET_VIEW(BLOCK_INDEX)
          IF(ASSOCIATED(SELF%F_NEMOPHIF)) SELF%NEMOPHIF => SELF%F_NEMOPHIF%GET_VIEW(BLOCK_INDEX)
          IF(ASSOCIATED(SELF%F_NTAUOC)) SELF%NTAUOC => SELF%F_NTAUOC%GET_VIEW(BLOCK_INDEX)
          IF(ASSOCIATED(SELF%F_NEMOTAUX)) SELF%NEMOTAUX => SELF%F_NEMOTAUX%GET_VIEW(BLOCK_INDEX)
          IF(ASSOCIATED(SELF%F_NEMOTAUY)) SELF%NEMOTAUY => SELF%F_NEMOTAUY%GET_VIEW(BLOCK_INDEX)
          IF(ASSOCIATED(SELF%F_NEMOUSTOKES)) SELF%NEMOUSTOKES => SELF%F_NEMOUSTOKES%GET_VIEW(BLOCK_INDEX)
          IF(ASSOCIATED(SELF%F_NEMOVSTOKES)) SELF%NEMOVSTOKES => SELF%F_NEMOVSTOKES%GET_VIEW(BLOCK_INDEX)
          IF(ASSOCIATED(SELF%F_NEMOSTRN)) SELF%NEMOSTRN => SELF%F_NEMOSTRN%GET_VIEW(BLOCK_INDEX)
          IF(ASSOCIATED(SELF%F_NEMOWSWAVE)) SELF%NEMOWSWAVE => SELF%F_NEMOWSWAVE%GET_VIEW(BLOCK_INDEX)
      END SUBROUTINE WAVE2OCEAN_UPDATE_VIEW
#endif

      SUBROUTINE WAVE2OCEAN_DEVICE_POINTER(SELF, NSWH, NMWP, NPHIEPS, NEMOPHIF, NTAUOC, NEMOTAUX, NEMOTAUY, NEMOUSTOKES,&
          & NEMOVSTOKES, NEMOSTRN, NEMOWSWAVE)
          CLASS(WAVE2OCEAN_FIELD), INTENT(INOUT) :: SELF
                REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: NSWH
                REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: NMWP
                REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: NPHIEPS
                REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: NEMOPHIF
                REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: NTAUOC
                REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: NEMOTAUX
                REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: NEMOTAUY
                REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: NEMOUSTOKES
                REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: NEMOVSTOKES
                REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: NEMOSTRN
                REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: NEMOWSWAVE
      
            IF(PRESENT(NSWH)) NSWH=>SELF%F_NSWH%DEVPTR
            IF(PRESENT(NMWP)) NMWP=>SELF%F_NMWP%DEVPTR
            IF(PRESENT(NPHIEPS)) NPHIEPS=>SELF%F_NPHIEPS%DEVPTR
            IF(PRESENT(NEMOPHIF)) NEMOPHIF=>SELF%F_NEMOPHIF%DEVPTR
            IF(PRESENT(NTAUOC)) NTAUOC=>SELF%F_NTAUOC%DEVPTR
            IF(PRESENT(NEMOTAUX)) NEMOTAUX=>SELF%F_NEMOTAUX%DEVPTR
            IF(PRESENT(NEMOTAUY)) NEMOTAUY=>SELF%F_NEMOTAUY%DEVPTR
            IF(PRESENT(NEMOUSTOKES)) NEMOUSTOKES=>SELF%F_NEMOUSTOKES%DEVPTR
            IF(PRESENT(NEMOVSTOKES)) NEMOVSTOKES=>SELF%F_NEMOVSTOKES%DEVPTR
            IF(PRESENT(NEMOSTRN)) NEMOSTRN=>SELF%F_NEMOSTRN%DEVPTR
            IF(PRESENT(NEMOWSWAVE)) NEMOWSWAVE=>SELF%F_NEMOWSWAVE%DEVPTR
      END SUBROUTINE WAVE2OCEAN_DEVICE_POINTER

      SUBROUTINE INTGT_PARAM_FIELDS_FIELD_INIT(SELF, WSEMEAN, WSFMEAN, USTOKES, VSTOKES, PHIEPS, PHIOCD, PHIAW, TAUOC, TAUXD,&
          & TAUYD, TAUOCXD, TAUOCYD, STRNMS, ALTWH, CALTWH, RALTCOR,LFORCE)
          CLASS(INTGT_PARAM_FIELDS_FIELD), INTENT(INOUT) :: SELF
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(IN), OPTIONAL :: WSEMEAN
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(IN), OPTIONAL :: WSFMEAN
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(IN), OPTIONAL :: USTOKES
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(IN), OPTIONAL :: VSTOKES
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(IN), OPTIONAL :: PHIEPS
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(IN), OPTIONAL :: PHIOCD
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(IN), OPTIONAL :: PHIAW
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(IN), OPTIONAL :: TAUOC
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(IN), OPTIONAL :: TAUXD
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(IN), OPTIONAL :: TAUYD
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(IN), OPTIONAL :: TAUOCXD
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(IN), OPTIONAL :: TAUOCYD
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(IN), OPTIONAL :: STRNMS
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(IN), OPTIONAL :: ALTWH
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(IN), OPTIONAL :: CALTWH
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(IN), OPTIONAL :: RALTCOR
          LOGICAL,INTENT(IN),OPTIONAL :: LFORCE ! force to allocate a new obj Yangjinhui 20230527
        
          IF(PRESENT(WSEMEAN)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_WSEMEAN) .OR. PRESENT(LFORCE)) SELF%F_WSEMEAN => WRAP_2D_REAL_FIELD(WSEMEAN)
          ENDIF
          IF(PRESENT(WSFMEAN)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_WSFMEAN) .OR. PRESENT(LFORCE)) SELF%F_WSFMEAN => WRAP_2D_REAL_FIELD(WSFMEAN)
          ENDIF
          IF(PRESENT(USTOKES)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_USTOKES) .OR. PRESENT(LFORCE)) SELF%F_USTOKES => WRAP_2D_REAL_FIELD(USTOKES)
          ENDIF
          IF(PRESENT(VSTOKES)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_VSTOKES) .OR. PRESENT(LFORCE)) SELF%F_VSTOKES => WRAP_2D_REAL_FIELD(VSTOKES)
          ENDIF
          IF(PRESENT(PHIEPS)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_PHIEPS) .OR. PRESENT(LFORCE)) SELF%F_PHIEPS => WRAP_2D_REAL_FIELD(PHIEPS)
          ENDIF
          IF(PRESENT(PHIOCD)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_PHIOCD) .OR. PRESENT(LFORCE)) SELF%F_PHIOCD => WRAP_2D_REAL_FIELD(PHIOCD)
          ENDIF
          IF(PRESENT(PHIAW)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_PHIAW) .OR. PRESENT(LFORCE)) SELF%F_PHIAW => WRAP_2D_REAL_FIELD(PHIAW)
          ENDIF
          IF(PRESENT(TAUOC)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_TAUOC) .OR. PRESENT(LFORCE)) SELF%F_TAUOC => WRAP_2D_REAL_FIELD(TAUOC)
          ENDIF
          IF(PRESENT(TAUXD)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_TAUXD) .OR. PRESENT(LFORCE)) SELF%F_TAUXD => WRAP_2D_REAL_FIELD(TAUXD)
          ENDIF
          IF(PRESENT(TAUYD)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_TAUYD) .OR. PRESENT(LFORCE)) SELF%F_TAUYD => WRAP_2D_REAL_FIELD(TAUYD)
          ENDIF
          IF(PRESENT(TAUOCXD)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_TAUOCXD) .OR. PRESENT(LFORCE)) SELF%F_TAUOCXD => WRAP_2D_REAL_FIELD(TAUOCXD)
          ENDIF
          IF(PRESENT(TAUOCYD)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_TAUOCYD) .OR. PRESENT(LFORCE)) SELF%F_TAUOCYD => WRAP_2D_REAL_FIELD(TAUOCYD)
          ENDIF
          IF(PRESENT(STRNMS)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_STRNMS) .OR. PRESENT(LFORCE)) SELF%F_STRNMS => WRAP_2D_REAL_FIELD(STRNMS)
          ENDIF
          IF(PRESENT(ALTWH)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_ALTWH) .OR. PRESENT(LFORCE)) SELF%F_ALTWH => WRAP_2D_REAL_FIELD(ALTWH)
          ENDIF
          IF(PRESENT(CALTWH)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_CALTWH) .OR. PRESENT(LFORCE)) SELF%F_CALTWH => WRAP_2D_REAL_FIELD(CALTWH)
          ENDIF
          IF(PRESENT(RALTCOR)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_RALTCOR) .OR. PRESENT(LFORCE)) SELF%F_RALTCOR => WRAP_2D_REAL_FIELD(RALTCOR)
          ENDIF
      END SUBROUTINE INTGT_PARAM_FIELDS_FIELD_INIT

      SUBROUTINE INTGT_PARAM_FIELDS_FIELD_INIT_UPDATE(SELF, WSEMEAN, WSFMEAN, USTOKES, VSTOKES, PHIEPS, PHIOCD, PHIAW, TAUOC,&
          & TAUXD, TAUYD, TAUOCXD, TAUOCYD, STRNMS, ALTWH, CALTWH, RALTCOR)
          CLASS(INTGT_PARAM_FIELDS_FIELD), INTENT(INOUT) :: SELF
            REAL(KIND=JWRB),TARGET, DIMENSION(:,:), INTENT(IN), OPTIONAL :: WSEMEAN
            REAL(KIND=JWRB),TARGET, DIMENSION(:,:), INTENT(IN), OPTIONAL :: WSFMEAN
            REAL(KIND=JWRB),TARGET, DIMENSION(:,:), INTENT(IN), OPTIONAL :: USTOKES
            REAL(KIND=JWRB),TARGET, DIMENSION(:,:), INTENT(IN), OPTIONAL :: VSTOKES
            REAL(KIND=JWRB),TARGET, DIMENSION(:,:), INTENT(IN), OPTIONAL :: PHIEPS
            REAL(KIND=JWRB),TARGET, DIMENSION(:,:), INTENT(IN), OPTIONAL :: PHIOCD
            REAL(KIND=JWRB),TARGET, DIMENSION(:,:), INTENT(IN), OPTIONAL :: PHIAW
            REAL(KIND=JWRB),TARGET, DIMENSION(:,:), INTENT(IN), OPTIONAL :: TAUOC
            REAL(KIND=JWRB),TARGET, DIMENSION(:,:), INTENT(IN), OPTIONAL :: TAUXD
            REAL(KIND=JWRB),TARGET, DIMENSION(:,:), INTENT(IN), OPTIONAL :: TAUYD
            REAL(KIND=JWRB),TARGET, DIMENSION(:,:), INTENT(IN), OPTIONAL :: TAUOCXD
            REAL(KIND=JWRB),TARGET, DIMENSION(:,:), INTENT(IN), OPTIONAL :: TAUOCYD
            REAL(KIND=JWRB),TARGET, DIMENSION(:,:), INTENT(IN), OPTIONAL :: STRNMS
            REAL(KIND=JWRB),TARGET, DIMENSION(:,:), INTENT(IN), OPTIONAL :: ALTWH
            REAL(KIND=JWRB),TARGET, DIMENSION(:,:), INTENT(IN), OPTIONAL :: CALTWH
            REAL(KIND=JWRB),TARGET, DIMENSION(:,:), INTENT(IN), OPTIONAL :: RALTCOR
      
        IF(PRESENT(WSEMEAN)) THEN
            IF(ASSOCIATED(SELF%F_WSEMEAN)) THEN
                SELF%F_WSEMEAN%PTR=>WSEMEAN
            ELSE
                SELF%F_WSEMEAN => WRAP_2D_REAL_FIELD(WSEMEAN)
            ENDIF
            CALL SELF%F_WSEMEAN%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
        IF(PRESENT(WSFMEAN)) THEN
            IF(ASSOCIATED(SELF%F_WSFMEAN)) THEN
                SELF%F_WSFMEAN%PTR=>WSFMEAN
            ELSE
                SELF%F_WSFMEAN => WRAP_2D_REAL_FIELD(WSFMEAN)
            ENDIF
            CALL SELF%F_WSFMEAN%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
        IF(PRESENT(USTOKES)) THEN
            IF(ASSOCIATED(SELF%F_USTOKES)) THEN
                SELF%F_USTOKES%PTR=>USTOKES
            ELSE
                SELF%F_USTOKES => WRAP_2D_REAL_FIELD(USTOKES)
            ENDIF
            CALL SELF%F_USTOKES%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
        IF(PRESENT(VSTOKES)) THEN
            IF(ASSOCIATED(SELF%F_VSTOKES)) THEN
                SELF%F_VSTOKES%PTR=>VSTOKES
            ELSE
                SELF%F_VSTOKES => WRAP_2D_REAL_FIELD(VSTOKES)
            ENDIF
            CALL SELF%F_VSTOKES%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
        IF(PRESENT(PHIEPS)) THEN
            IF(ASSOCIATED(SELF%F_PHIEPS)) THEN
                SELF%F_PHIEPS%PTR=>PHIEPS
            ELSE
                SELF%F_PHIEPS => WRAP_2D_REAL_FIELD(PHIEPS)
            ENDIF
            CALL SELF%F_PHIEPS%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
        IF(PRESENT(PHIOCD)) THEN
            IF(ASSOCIATED(SELF%F_PHIOCD)) THEN
                SELF%F_PHIOCD%PTR=>PHIOCD
            ELSE
                SELF%F_PHIOCD => WRAP_2D_REAL_FIELD(PHIOCD)
            ENDIF
            CALL SELF%F_PHIOCD%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
        IF(PRESENT(PHIAW)) THEN
            IF(ASSOCIATED(SELF%F_PHIAW)) THEN
                SELF%F_PHIAW%PTR=>PHIAW
            ELSE
                SELF%F_PHIAW => WRAP_2D_REAL_FIELD(PHIAW)
            ENDIF
            CALL SELF%F_PHIAW%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
        IF(PRESENT(TAUOC)) THEN
            IF(ASSOCIATED(SELF%F_TAUOC)) THEN
                SELF%F_TAUOC%PTR=>TAUOC
            ELSE
                SELF%F_TAUOC => WRAP_2D_REAL_FIELD(TAUOC)
            ENDIF
            CALL SELF%F_TAUOC%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
        IF(PRESENT(TAUXD)) THEN
            IF(ASSOCIATED(SELF%F_TAUXD)) THEN
                SELF%F_TAUXD%PTR=>TAUXD
            ELSE
                SELF%F_TAUXD => WRAP_2D_REAL_FIELD(TAUXD)
            ENDIF
            CALL SELF%F_TAUXD%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
        IF(PRESENT(TAUYD)) THEN
            IF(ASSOCIATED(SELF%F_TAUYD)) THEN
                SELF%F_TAUYD%PTR=>TAUYD
            ELSE
                SELF%F_TAUYD => WRAP_2D_REAL_FIELD(TAUYD)
            ENDIF
            CALL SELF%F_TAUYD%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
        IF(PRESENT(TAUOCXD)) THEN
            IF(ASSOCIATED(SELF%F_TAUOCXD)) THEN
                SELF%F_TAUOCXD%PTR=>TAUOCXD
            ELSE
                SELF%F_TAUOCXD => WRAP_2D_REAL_FIELD(TAUOCXD)
            ENDIF
            CALL SELF%F_TAUOCXD%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
        IF(PRESENT(TAUOCYD)) THEN
            IF(ASSOCIATED(SELF%F_TAUOCYD)) THEN
                SELF%F_TAUOCYD%PTR=>TAUOCYD
            ELSE
                SELF%F_TAUOCYD => WRAP_2D_REAL_FIELD(TAUOCYD)
            ENDIF
            CALL SELF%F_TAUOCYD%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
        IF(PRESENT(STRNMS)) THEN
            IF(ASSOCIATED(SELF%F_STRNMS)) THEN
                SELF%F_STRNMS%PTR=>STRNMS
            ELSE
                SELF%F_STRNMS => WRAP_2D_REAL_FIELD(STRNMS)
            ENDIF
            CALL SELF%F_STRNMS%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
        IF(PRESENT(ALTWH)) THEN
            IF(ASSOCIATED(SELF%F_ALTWH)) THEN
                SELF%F_ALTWH%PTR=>ALTWH
            ELSE
                SELF%F_ALTWH => WRAP_2D_REAL_FIELD(ALTWH)
            ENDIF
            CALL SELF%F_ALTWH%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
        IF(PRESENT(CALTWH)) THEN
            IF(ASSOCIATED(SELF%F_CALTWH)) THEN
                SELF%F_CALTWH%PTR=>CALTWH
            ELSE
                SELF%F_CALTWH => WRAP_2D_REAL_FIELD(CALTWH)
            ENDIF
            CALL SELF%F_CALTWH%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
        IF(PRESENT(RALTCOR)) THEN
            IF(ASSOCIATED(SELF%F_RALTCOR)) THEN
                SELF%F_RALTCOR%PTR=>RALTCOR
            ELSE
                SELF%F_RALTCOR => WRAP_2D_REAL_FIELD(RALTCOR)
            ENDIF
            CALL SELF%F_RALTCOR%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
      END SUBROUTINE INTGT_PARAM_FIELDS_FIELD_INIT_UPDATE

#ifdef WAM_PHYS_GPU
      SUBROUTINE INTGT_PARAM_FIELDS_UPDATE_DEVICE(SELF, WSEMEAN, WSFMEAN, USTOKES, VSTOKES, PHIEPS, PHIOCD, PHIAW, TAUOC, TAUXD,&
          & TAUYD, TAUOCXD, TAUOCYD, STRNMS, ALTWH, CALTWH, RALTCOR)
          CLASS(INTGT_PARAM_FIELDS_FIELD), INTENT(INOUT) :: SELF
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: WSEMEAN
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: WSFMEAN
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: USTOKES
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: VSTOKES
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: PHIEPS
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: PHIOCD
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: PHIAW
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: TAUOC
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: TAUXD
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: TAUYD
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: TAUOCXD
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: TAUOCYD
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: STRNMS
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: ALTWH
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: CALTWH
          REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: RALTCOR

          IF(PRESENT(WSEMEAN)) CALL SELF%F_WSEMEAN%GET_DEVICE_DATA_RDWR(WSEMEAN)
          IF(PRESENT(WSFMEAN)) CALL SELF%F_WSFMEAN%GET_DEVICE_DATA_RDWR(WSFMEAN)
          IF(PRESENT(USTOKES)) CALL SELF%F_USTOKES%GET_DEVICE_DATA_RDWR(USTOKES)
          IF(PRESENT(VSTOKES)) CALL SELF%F_VSTOKES%GET_DEVICE_DATA_RDWR(VSTOKES)
          IF(PRESENT(PHIEPS)) CALL SELF%F_PHIEPS%GET_DEVICE_DATA_RDWR(PHIEPS)
          IF(PRESENT(PHIOCD)) CALL SELF%F_PHIOCD%GET_DEVICE_DATA_RDWR(PHIOCD)
          IF(PRESENT(PHIAW)) CALL SELF%F_PHIAW%GET_DEVICE_DATA_RDWR(PHIAW)
          IF(PRESENT(TAUOC)) CALL SELF%F_TAUOC%GET_DEVICE_DATA_RDWR(TAUOC)
          IF(PRESENT(TAUXD)) CALL SELF%F_TAUXD%GET_DEVICE_DATA_RDWR(TAUXD)
          IF(PRESENT(TAUYD)) CALL SELF%F_TAUYD%GET_DEVICE_DATA_RDWR(TAUYD)
          IF(PRESENT(TAUOCXD)) CALL SELF%F_TAUOCXD%GET_DEVICE_DATA_RDWR(TAUOCXD)
          IF(PRESENT(TAUOCYD)) CALL SELF%F_TAUOCYD%GET_DEVICE_DATA_RDWR(TAUOCYD)
          IF(PRESENT(STRNMS)) CALL SELF%F_STRNMS%GET_DEVICE_DATA_RDWR(STRNMS)
          IF(PRESENT(ALTWH)) CALL SELF%F_ALTWH%GET_DEVICE_DATA_RDWR(ALTWH)
          IF(PRESENT(CALTWH)) CALL SELF%F_CALTWH%GET_DEVICE_DATA_RDWR(CALTWH)
          IF(PRESENT(RALTCOR)) CALL SELF%F_RALTCOR%GET_DEVICE_DATA_RDWR(RALTCOR)
      END SUBROUTINE INTGT_PARAM_FIELDS_UPDATE_DEVICE

      SUBROUTINE INTGT_PARAM_FIELDS_ENSURE_HOST(SELF,LWSEMEAN, LWSFMEAN, LUSTOKES, LVSTOKES, LPHIEPS, LPHIOCD, LPHIAW, LTAUOC,&
          & LTAUXD, LTAUYD, LTAUOCXD, LTAUOCYD, LSTRNMS, LALTWH, LCALTWH, LRALTCOR,ICHNK)
          CLASS(INTGT_PARAM_FIELDS_FIELD), INTENT(INOUT) :: SELF
               LOGICAL,INTENT(IN),OPTIONAL :: LWSEMEAN
               LOGICAL,INTENT(IN),OPTIONAL :: LWSFMEAN
               LOGICAL,INTENT(IN),OPTIONAL :: LUSTOKES
               LOGICAL,INTENT(IN),OPTIONAL :: LVSTOKES
               LOGICAL,INTENT(IN),OPTIONAL :: LPHIEPS
               LOGICAL,INTENT(IN),OPTIONAL :: LPHIOCD
               LOGICAL,INTENT(IN),OPTIONAL :: LPHIAW
               LOGICAL,INTENT(IN),OPTIONAL :: LTAUOC
               LOGICAL,INTENT(IN),OPTIONAL :: LTAUXD
               LOGICAL,INTENT(IN),OPTIONAL :: LTAUYD
               LOGICAL,INTENT(IN),OPTIONAL :: LTAUOCXD
               LOGICAL,INTENT(IN),OPTIONAL :: LTAUOCYD
               LOGICAL,INTENT(IN),OPTIONAL :: LSTRNMS
               LOGICAL,INTENT(IN),OPTIONAL :: LALTWH
               LOGICAL,INTENT(IN),OPTIONAL :: LCALTWH
               LOGICAL,INTENT(IN),OPTIONAL :: LRALTCOR
          INTEGER(KIND=JWIM),OPTIONAL,INTENT(IN):: ICHNK

          IF(PRESENT(LWSEMEAN) .AND. ASSOCIATED(SELF%F_WSEMEAN)) CALL SELF%F_WSEMEAN%ENSURE_HOST(ICHNK)
          IF(PRESENT(LWSFMEAN) .AND. ASSOCIATED(SELF%F_WSFMEAN)) CALL SELF%F_WSFMEAN%ENSURE_HOST(ICHNK)
          IF(PRESENT(LUSTOKES) .AND. ASSOCIATED(SELF%F_USTOKES)) CALL SELF%F_USTOKES%ENSURE_HOST(ICHNK)
          IF(PRESENT(LVSTOKES) .AND. ASSOCIATED(SELF%F_VSTOKES)) CALL SELF%F_VSTOKES%ENSURE_HOST(ICHNK)
          IF(PRESENT(LPHIEPS) .AND. ASSOCIATED(SELF%F_PHIEPS)) CALL SELF%F_PHIEPS%ENSURE_HOST(ICHNK)
          IF(PRESENT(LPHIOCD) .AND. ASSOCIATED(SELF%F_PHIOCD)) CALL SELF%F_PHIOCD%ENSURE_HOST(ICHNK)
          IF(PRESENT(LPHIAW) .AND. ASSOCIATED(SELF%F_PHIAW)) CALL SELF%F_PHIAW%ENSURE_HOST(ICHNK)
          IF(PRESENT(LTAUOC) .AND. ASSOCIATED(SELF%F_TAUOC)) CALL SELF%F_TAUOC%ENSURE_HOST(ICHNK)
          IF(PRESENT(LTAUXD) .AND. ASSOCIATED(SELF%F_TAUXD)) CALL SELF%F_TAUXD%ENSURE_HOST(ICHNK)
          IF(PRESENT(LTAUYD) .AND. ASSOCIATED(SELF%F_TAUYD)) CALL SELF%F_TAUYD%ENSURE_HOST(ICHNK)
          IF(PRESENT(LTAUOCXD) .AND. ASSOCIATED(SELF%F_TAUOCXD)) CALL SELF%F_TAUOCXD%ENSURE_HOST(ICHNK)
          IF(PRESENT(LTAUOCYD) .AND. ASSOCIATED(SELF%F_TAUOCYD)) CALL SELF%F_TAUOCYD%ENSURE_HOST(ICHNK)
          IF(PRESENT(LSTRNMS) .AND. ASSOCIATED(SELF%F_STRNMS)) CALL SELF%F_STRNMS%ENSURE_HOST(ICHNK)
          IF(PRESENT(LALTWH) .AND. ASSOCIATED(SELF%F_ALTWH)) CALL SELF%F_ALTWH%ENSURE_HOST(ICHNK)
          IF(PRESENT(LCALTWH) .AND. ASSOCIATED(SELF%F_CALTWH)) CALL SELF%F_CALTWH%ENSURE_HOST(ICHNK)
          IF(PRESENT(LRALTCOR) .AND. ASSOCIATED(SELF%F_RALTCOR)) CALL SELF%F_RALTCOR%ENSURE_HOST(ICHNK)
      END SUBROUTINE INTGT_PARAM_FIELDS_ENSURE_HOST
#else
      SUBROUTINE INTGT_PARAM_FIELDS_UPDATE_VIEW(SELF, BLOCK_INDEX)
          CLASS(INTGT_PARAM_FIELDS_FIELD), INTENT(INOUT) :: SELF
          INTEGER(KIND=JWIM), INTENT(IN) :: BLOCK_INDEX

          IF(ASSOCIATED(SELF%F_WSEMEAN)) SELF%WSEMEAN => SELF%F_WSEMEAN%GET_VIEW(BLOCK_INDEX)
          IF(ASSOCIATED(SELF%F_WSFMEAN)) SELF%WSFMEAN => SELF%F_WSFMEAN%GET_VIEW(BLOCK_INDEX)
          IF(ASSOCIATED(SELF%F_USTOKES)) SELF%USTOKES => SELF%F_USTOKES%GET_VIEW(BLOCK_INDEX)
          IF(ASSOCIATED(SELF%F_VSTOKES)) SELF%VSTOKES => SELF%F_VSTOKES%GET_VIEW(BLOCK_INDEX)
          IF(ASSOCIATED(SELF%F_PHIEPS)) SELF%PHIEPS => SELF%F_PHIEPS%GET_VIEW(BLOCK_INDEX)
          IF(ASSOCIATED(SELF%F_PHIOCD)) SELF%PHIOCD => SELF%F_PHIOCD%GET_VIEW(BLOCK_INDEX)
          IF(ASSOCIATED(SELF%F_PHIAW)) SELF%PHIAW => SELF%F_PHIAW%GET_VIEW(BLOCK_INDEX)
          IF(ASSOCIATED(SELF%F_TAUOC)) SELF%TAUOC => SELF%F_TAUOC%GET_VIEW(BLOCK_INDEX)
          IF(ASSOCIATED(SELF%F_TAUXD)) SELF%TAUXD => SELF%F_TAUXD%GET_VIEW(BLOCK_INDEX)
          IF(ASSOCIATED(SELF%F_TAUYD)) SELF%TAUYD => SELF%F_TAUYD%GET_VIEW(BLOCK_INDEX)
          IF(ASSOCIATED(SELF%F_TAUOCXD)) SELF%TAUOCXD => SELF%F_TAUOCXD%GET_VIEW(BLOCK_INDEX)
          IF(ASSOCIATED(SELF%F_TAUOCYD)) SELF%TAUOCYD => SELF%F_TAUOCYD%GET_VIEW(BLOCK_INDEX)
          IF(ASSOCIATED(SELF%F_STRNMS)) SELF%STRNMS => SELF%F_STRNMS%GET_VIEW(BLOCK_INDEX)
          IF(ASSOCIATED(SELF%F_ALTWH)) SELF%ALTWH => SELF%F_ALTWH%GET_VIEW(BLOCK_INDEX)
          IF(ASSOCIATED(SELF%F_CALTWH)) SELF%CALTWH => SELF%F_CALTWH%GET_VIEW(BLOCK_INDEX)
          IF(ASSOCIATED(SELF%F_RALTCOR)) SELF%RALTCOR => SELF%F_RALTCOR%GET_VIEW(BLOCK_INDEX)
      END SUBROUTINE INTGT_PARAM_FIELDS_UPDATE_VIEW
#endif

      SUBROUTINE INTGT_PARAM_FIELDS_DEVICE_POINTER(SELF, WSEMEAN, WSFMEAN, USTOKES, VSTOKES, PHIEPS, PHIOCD, PHIAW, TAUOC, TAUXD,&
          & TAUYD, TAUOCXD, TAUOCYD, STRNMS, ALTWH, CALTWH, RALTCOR)
          CLASS(INTGT_PARAM_FIELDS_FIELD), INTENT(INOUT) :: SELF
                REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: WSEMEAN
                REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: WSFMEAN
                REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: USTOKES
                REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: VSTOKES
                REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: PHIEPS
                REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: PHIOCD
                REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: PHIAW
                REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: TAUOC
                REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: TAUXD
                REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: TAUYD
                REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: TAUOCXD
                REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: TAUOCYD
                REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: STRNMS
                REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: ALTWH
                REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: CALTWH
                REAL(KIND=JWRB), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: RALTCOR
      
            IF(PRESENT(WSEMEAN)) WSEMEAN=>SELF%F_WSEMEAN%DEVPTR
            IF(PRESENT(WSFMEAN)) WSFMEAN=>SELF%F_WSFMEAN%DEVPTR
            IF(PRESENT(USTOKES)) USTOKES=>SELF%F_USTOKES%DEVPTR
            IF(PRESENT(VSTOKES)) VSTOKES=>SELF%F_VSTOKES%DEVPTR
            IF(PRESENT(PHIEPS)) PHIEPS=>SELF%F_PHIEPS%DEVPTR
            IF(PRESENT(PHIOCD)) PHIOCD=>SELF%F_PHIOCD%DEVPTR
            IF(PRESENT(PHIAW)) PHIAW=>SELF%F_PHIAW%DEVPTR
            IF(PRESENT(TAUOC)) TAUOC=>SELF%F_TAUOC%DEVPTR
            IF(PRESENT(TAUXD)) TAUXD=>SELF%F_TAUXD%DEVPTR
            IF(PRESENT(TAUYD)) TAUYD=>SELF%F_TAUYD%DEVPTR
            IF(PRESENT(TAUOCXD)) TAUOCXD=>SELF%F_TAUOCXD%DEVPTR
            IF(PRESENT(TAUOCYD)) TAUOCYD=>SELF%F_TAUOCYD%DEVPTR
            IF(PRESENT(STRNMS)) STRNMS=>SELF%F_STRNMS%DEVPTR
            IF(PRESENT(ALTWH)) ALTWH=>SELF%F_ALTWH%DEVPTR
            IF(PRESENT(CALTWH)) CALTWH=>SELF%F_CALTWH%DEVPTR
            IF(PRESENT(RALTCOR)) RALTCOR=>SELF%F_RALTCOR%DEVPTR
      END SUBROUTINE INTGT_PARAM_FIELDS_DEVICE_POINTER

      SUBROUTINE SOURCE_CONTRIBS_FIELD_INIT(SELF, FL1, XLLWS, MIJ,LFORCE)
          CLASS(SOURCE_CONTRIBS_FIELD), INTENT(INOUT) :: SELF
          REAL(KIND=JWRB), DIMENSION(:,:,:,:), INTENT(IN), OPTIONAL :: FL1
          REAL(KIND=JWRB), DIMENSION(:,:,:,:), INTENT(IN), OPTIONAL :: XLLWS
          INTEGER(KIND=JWIM), DIMENSION(:,:), INTENT(IN), OPTIONAL :: MIJ
          LOGICAL,INTENT(IN),OPTIONAL :: LFORCE ! force to allocate a new obj Yangjinhui 20230527
        
          IF(PRESENT(FL1)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_FL1) .OR. PRESENT(LFORCE)) SELF%F_FL1 => WRAP_4D_REAL_FIELD(FL1)
          ENDIF
          IF(PRESENT(XLLWS)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_XLLWS) .OR. PRESENT(LFORCE)) SELF%F_XLLWS => WRAP_4D_REAL_FIELD(XLLWS)
          ENDIF
          IF(PRESENT(MIJ)) THEN
            IF(.NOT. ASSOCIATED(SELF%F_MIJ) .OR. PRESENT(LFORCE)) SELF%F_MIJ => WRAP_2D_INT_FIELD(MIJ)
          ENDIF
      END SUBROUTINE SOURCE_CONTRIBS_FIELD_INIT

      SUBROUTINE SOURCE_CONTRIBS_FIELD_INIT_UPDATE(SELF, FL1, XLLWS, MIJ)
          CLASS(SOURCE_CONTRIBS_FIELD), INTENT(INOUT) :: SELF
            REAL(KIND=JWRB),TARGET, DIMENSION(:,:,:,:), INTENT(IN), OPTIONAL :: FL1
            REAL(KIND=JWRB),TARGET, DIMENSION(:,:,:,:), INTENT(IN), OPTIONAL :: XLLWS
            INTEGER(KIND=JWIM),TARGET, DIMENSION(:,:), INTENT(IN), OPTIONAL :: MIJ
      
        IF(PRESENT(FL1)) THEN
            IF(ASSOCIATED(SELF%F_FL1)) THEN
                SELF%F_FL1%PTR=>FL1
            ELSE
                SELF%F_FL1 => WRAP_4D_REAL_FIELD(FL1)
            ENDIF
            CALL SELF%F_FL1%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
        IF(PRESENT(XLLWS)) THEN
            IF(ASSOCIATED(SELF%F_XLLWS)) THEN
                SELF%F_XLLWS%PTR=>XLLWS
            ELSE
                SELF%F_XLLWS => WRAP_4D_REAL_FIELD(XLLWS)
            ENDIF
            CALL SELF%F_XLLWS%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
        IF(PRESENT(MIJ)) THEN
            IF(ASSOCIATED(SELF%F_MIJ)) THEN
                SELF%F_MIJ%PTR=>MIJ
            ELSE
                SELF%F_MIJ => WRAP_2D_INT_FIELD(MIJ)
            ENDIF
            CALL SELF%F_MIJ%GET_DEVICE_DATA_RDWR() ! updated
        ENDIF
      END SUBROUTINE SOURCE_CONTRIBS_FIELD_INIT_UPDATE

#ifdef WAM_PHYS_GPU
      SUBROUTINE SOURCE_CONTRIBS_UPDATE_DEVICE(SELF, FL1, XLLWS, MIJ)
          CLASS(SOURCE_CONTRIBS_FIELD), INTENT(INOUT) :: SELF
          REAL(KIND=JWRB), DIMENSION(:,:,:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: FL1
          REAL(KIND=JWRB), DIMENSION(:,:,:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: XLLWS
          INTEGER(KIND=JWIM), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: MIJ

          IF(PRESENT(FL1)) CALL SELF%F_FL1%GET_DEVICE_DATA_RDWR(FL1)
          IF(PRESENT(XLLWS)) CALL SELF%F_XLLWS%GET_DEVICE_DATA_RDWR(XLLWS)
          IF(PRESENT(MIJ)) CALL SELF%F_MIJ%GET_DEVICE_DATA_RDWR(MIJ)
      END SUBROUTINE SOURCE_CONTRIBS_UPDATE_DEVICE

      SUBROUTINE SOURCE_CONTRIBS_ENSURE_HOST(SELF,LFL1, LXLLWS, LMIJ,ICHNK)
          CLASS(SOURCE_CONTRIBS_FIELD), INTENT(INOUT) :: SELF
               LOGICAL,INTENT(IN),OPTIONAL :: LFL1
               LOGICAL,INTENT(IN),OPTIONAL :: LXLLWS
               LOGICAL,INTENT(IN),OPTIONAL :: LMIJ
          INTEGER(KIND=JWIM),OPTIONAL,INTENT(IN):: ICHNK

          IF(PRESENT(LFL1) .AND. ASSOCIATED(SELF%F_FL1)) CALL SELF%F_FL1%ENSURE_HOST(ICHNK)
          IF(PRESENT(LXLLWS) .AND. ASSOCIATED(SELF%F_XLLWS)) CALL SELF%F_XLLWS%ENSURE_HOST(ICHNK)
          IF(PRESENT(LMIJ) .AND. ASSOCIATED(SELF%F_MIJ)) CALL SELF%F_MIJ%ENSURE_HOST(ICHNK)
      END SUBROUTINE SOURCE_CONTRIBS_ENSURE_HOST
#else
      SUBROUTINE SOURCE_CONTRIBS_UPDATE_VIEW(SELF, BLOCK_INDEX)
          CLASS(SOURCE_CONTRIBS_FIELD), INTENT(INOUT) :: SELF
          INTEGER(KIND=JWIM), INTENT(IN) :: BLOCK_INDEX

          IF(ASSOCIATED(SELF%F_FL1)) SELF%FL1 => SELF%F_FL1%GET_VIEW(BLOCK_INDEX)
          IF(ASSOCIATED(SELF%F_XLLWS)) SELF%XLLWS => SELF%F_XLLWS%GET_VIEW(BLOCK_INDEX)
          IF(ASSOCIATED(SELF%F_MIJ)) SELF%MIJ => SELF%F_MIJ%GET_VIEW(BLOCK_INDEX)
      END SUBROUTINE SOURCE_CONTRIBS_UPDATE_VIEW
#endif

      SUBROUTINE SOURCE_CONTRIBS_DEVICE_POINTER(SELF, FL1, XLLWS, MIJ)
          CLASS(SOURCE_CONTRIBS_FIELD), INTENT(INOUT) :: SELF
                REAL(KIND=JWRB), DIMENSION(:,:,:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: FL1
                REAL(KIND=JWRB), DIMENSION(:,:,:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: XLLWS
                INTEGER(KIND=JWIM), DIMENSION(:,:), INTENT(OUT), POINTER, CONTIGUOUS, OPTIONAL :: MIJ
      
            IF(PRESENT(FL1)) FL1=>SELF%F_FL1%DEVPTR
            IF(PRESENT(XLLWS)) XLLWS=>SELF%F_XLLWS%DEVPTR
            IF(PRESENT(MIJ)) MIJ=>SELF%F_MIJ%DEVPTR
      END SUBROUTINE SOURCE_CONTRIBS_DEVICE_POINTER

END MODULE YOWFIELD_MOD
